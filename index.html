<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Lite G6 - Cirineo (Edición Balta)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        /* ESTILOS DEL DISEÑO CIRINEO NEXO (Referencia) */
        body { margin: 0; background: #020617; font-family: 'Inter', sans-serif; overflow: hidden; color: white; }
        
        .glass-panel { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.1); }
        .glass-card { background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .glass-card:active { transform: scale(0.98); background: rgba(255, 255, 255, 0.15); }
        
        /* Scanner Estilo Laser 6:1 */
        #reader { width: 100% !important; border: none !important; height: 100% !important; }
        #reader video { object-fit: cover !important; width: 100% !important; height: 100% !important; border-radius: 12px; }
        
        .scan-window { 
            height: 150px; /* Un poco más alto para facilitar el encuadre */
            width: 100%;
            border: 2px solid #0ea5e9; 
            border-radius: 16px; 
            overflow: hidden; 
            position: relative; 
            background: #000;
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.3);
        }
        
        .scan-laser { 
            position: absolute; 
            width: 100%; 
            height: 2px; 
            background: #38bdf8; 
            box-shadow: 0 0 15px #38bdf8, 0 0 30px #0ea5e9; 
            animation: laserMove 2s infinite linear; 
            z-index: 10; 
            top: 0;
        }
        
        @keyframes laserMove { 
            0% { top: 0%; opacity: 0.8; } 
            50% { top: 100%; opacity: 1; } 
            100% { top: 0%; opacity: 0.8; } 
        }

        /* Utilidades */
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const FieldValue = firebase.firestore.FieldValue;

        const Icon = ({ name, size = 24, className, onClick }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && lucide.icons[name]) {
                    ref.current.innerHTML = lucide.icons[name].toSvg({ width: size, height: size, class: className });
                }
            }, [name, className]);
            return <span ref={ref} onClick={onClick} className={`inline-flex items-center justify-center ${onClick ? 'cursor-pointer' : ''}`}></span>;
        };

        const playBeep = () => {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = 'sine'; 
                osc.frequency.setValueAtTime(1200, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(600, ctx.currentTime + 0.15);
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
                osc.connect(gain); gain.connect(ctx.destination); 
                osc.start(); osc.stop(ctx.currentTime + 0.15);
            } catch(e) {}
        };

        // --- COMPONENTE MODAL DEL ESCÁNER (ESTILO NEXO) ---
        const QuickScannerModal = ({ isVisible, onClose, ordersCache, onScanSaved }) => {
            const [scans, setScans] = useState([]); 
            const [isSaving, setIsSaving] = useState(false);
            const [status, setStatus] = useState("Cámara lista");
            const html5QrCodeRef = useRef(null);
            const lastCodeRef = useRef({ code: '', time: 0 });

            useEffect(() => {
                if (isVisible) {
                    setScans([]);
                    startScanner();
                } else {
                    stopScanner();
                }
                return () => stopScanner();
            }, [isVisible]);

            const startScanner = async () => {
                try {
                    // Usamos Html5Qrcode directo para controlar el DOM como en el index.html
                    const html5QrCode = new Html5Qrcode("reader");
                    html5QrCodeRef.current = html5QrCode;

                    const config = { 
                        fps: 15, 
                        qrbox: { width: 300, height: 100 }, // Área de lectura rectangular
                        aspectRatio: 1.0 
                    };

                    await html5QrCode.start(
                        { facingMode: "environment" }, 
                        config, 
                        (decodedText) => handleQuickScan(decodedText),
                        (errorMessage) => { /* ignorar errores de frame vacío */ }
                    );
                } catch (err) {
                    console.error("Error cámara", err);
                    setStatus("Error al iniciar cámara");
                }
            };

            const stopScanner = async () => {
                if (html5QrCodeRef.current) {
                    try {
                        await html5QrCodeRef.current.stop();
                        html5QrCodeRef.current.clear();
                    } catch(e) {}
                    html5QrCodeRef.current = null;
                }
            };

            const handleQuickScan = (rawCode) => {
                const now = Date.now();
                const cleanCode = rawCode.trim().toUpperCase().replace(/'/g, '-').replace(/\?/g, '_');

                // Evitar lecturas dobles muy rápidas (menos de 2 segs el mismo código)
                if (cleanCode === lastCodeRef.current.code && (now - lastCodeRef.current.time) < 2000) return;
                lastCodeRef.current = { code: cleanCode, time: now };

                // Validar si ya está en la lista actual
                if (scans.some(s => s.code === cleanCode)) {
                    setStatus(`¡${cleanCode} YA ESTÁ EN LA LISTA!`);
                    return;
                }

                // Buscar en caché de órdenes
                let foundPackage = null;
                for (const order of ordersCache) {
                    if (order.progreso) {
                        const pkg = order.progreso.find(p => p.codigoUnico === cleanCode);
                        if (pkg) {
                            foundPackage = { 
                                code: cleanCode, 
                                orderId: order.id, 
                                modelo: order.codigo, 
                                partida: order.partida,
                                piezaNombre: pkg.piezaNombre,
                                paquete_indice: pkg.paqueteNum, 
                                paquete_total: pkg.paquetesDePieza, 
                                piezas_en_paquete: pkg.cantidad,
                                // *** AQUÍ ESTÁ EL CAMBIO SOLICITADO: ***
                                tejedor: "Balta" 
                            };
                            break;
                        }
                    }
                }

                if (foundPackage) {
                    playBeep();
                    setScans(prev => [foundPackage, ...prev]);
                    setStatus(`Leído: ${foundPackage.modelo} #${foundPackage.paquete_indice}`);
                } else {
                    setStatus(`Código ${cleanCode} NO ENCONTRADO`);
                }
            };

            const confirmScans = async () => {
                if (scans.length === 0 || isSaving) return;
                setIsSaving(true);
                
                const batch = db.batch();
                let savedCount = 0;

                for (const scan of scans) {
                    // Verificación básica de duplicado en DB antes de subir (opcional, pero recomendada)
                    // Para rapidez en UI, asumimos éxito y el backend/reglas manejarán consistencia,
                    // pero mantenemos la lógica original de crear documentos.
                    const docRef = db.collection('registro_produccion').doc();
                    batch.set(docRef, {
                        codigo_paquete: scan.code, 
                        orderId: String(scan.orderId), 
                        fecha: FieldValue.serverTimestamp(),
                        fecha_legible: new Date().toLocaleDateString('es-MX', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }).replace(/\//g, '/'), 
                        tejedor: scan.tejedor, // Guardará "Balta"
                        tipo: "produccion",
                        modelo: scan.modelo,
                        partida: scan.partida,
                        paquete_indice: scan.paquete_indice, 
                        paquete_total: scan.paquete_total,
                        piezas_en_paquete: scan.piezas_en_paquete
                    });
                    savedCount++;
                }

                await batch.commit();
                setIsSaving(false);
                onScanSaved(savedCount);
                onClose();
            };

            const removeScan = (code) => {
                setScans(prev => prev.filter(s => s.code !== code));
            };

            if (!isVisible) return null;

            return (
                <div className="fixed inset-0 z-50 bg-[#020617] flex flex-col p-6 animate-fade-in">
                    {/* Header */}
                    <div className="flex justify-between items-center mb-6">
                        <div>
                            <h2 className="text-white text-2xl font-black uppercase tracking-tighter flex items-center gap-2">
                                <Icon name="camera" className="text-blue-500"/>
                                ESCÁNER G6
                            </h2>
                            <p className="text-slate-500 text-xs font-bold tracking-[0.2em] uppercase">USUARIO: BALTA</p>
                        </div>
                        <button onClick={onClose} className="w-12 h-12 bg-white/5 rounded-2xl flex items-center justify-center text-white border border-white/10 hover:bg-white/10">
                            <Icon name="x"/>
                        </button>
                    </div>

                    {/* Área de Cámara Estilo Index */}
                    <div className="scan-window mb-4 shadow-2xl shadow-blue-900/20">
                        <div id="reader"></div>
                        <div className="scan-laser"></div>
                    </div>
                    
                    {/* Status Bar */}
                    <div className="text-center mb-4">
                         <span className={`text-xs font-bold px-3 py-1 rounded-full ${status.includes('NO') ? 'bg-red-900/50 text-red-400' : 'bg-blue-900/30 text-blue-400'}`}>
                            {status}
                        </span>
                    </div>

                    {/* Lista de Escaneos */}
                    <div className="flex-1 overflow-y-auto space-y-3 mb-4 pr-1">
                        {scans.length === 0 ? (
                            <div className="h-full flex flex-col items-center justify-center text-slate-700 opacity-50">
                                <Icon name="qr-code" size={48} className="mb-2"/>
                                <span className="text-sm font-bold uppercase tracking-widest">Esperando códigos...</span>
                            </div>
                        ) : (
                            scans.map((s, i) => (
                                <div key={s.code} className="glass-card p-4 rounded-2xl flex justify-between items-center animate-fade-in group">
                                    <div>
                                        <div className="font-mono font-bold text-sky-400 text-lg">{s.code}</div>
                                        <div className="text-[10px] text-slate-400 font-bold uppercase tracking-wide">
                                            {s.modelo} • Pqt {s.paquete_indice}/{s.paquete_total}
                                        </div>
                                    </div>
                                    <button onClick={() => removeScan(s.code)} className="text-slate-600 hover:text-red-400 transition-colors">
                                        <Icon name="trash-2" size={18}/>
                                    </button>
                                </div>
                            ))
                        )}
                    </div>

                    {/* Botón de Acción */}
                    <button 
                        onClick={confirmScans}
                        disabled={scans.length === 0 || isSaving}
                        className={`w-full py-5 rounded-3xl font-black text-white shadow-xl transition-all
                            ${scans.length > 0 && !isSaving 
                                ? 'bg-blue-600 hover:bg-blue-500 shadow-blue-900/40' 
                                : 'bg-slate-800 text-slate-500 cursor-not-allowed'}`}
                    >
                        {isSaving ? 'GUARDANDO...' : `CONFIRMAR (${scans.length})`}
                    </button>
                </div>
            );
        };

        // --- COMPONENTE PRINCIPAL (DASHBOARD) ---
        const ScannerG6 = () => {
            const [ordersCache, setOrdersCache] = useState([]);
            const [statusMsg, setStatusMsg] = useState("Cargando base de datos...");
            const [showScanner, setShowScanner] = useState(false);
            const [lastSaveCount, setLastSaveCount] = useState(0);

            useEffect(() => {
                const unsubscribe = db.collection('orders')
                    .where('status', '!=', 'ARCHIVADO')
                    .onSnapshot(snapshot => {
                        const loadedOrders = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                        setOrdersCache(loadedOrders);
                        setStatusMsg(`${loadedOrders.length} Órdenes Activas`);
                    });
                return () => unsubscribe();
            }, []);

            return (
                <div className="h-screen w-screen bg-[#020617] text-white flex flex-col p-6 overflow-hidden relative">
                    {/* Fondo decorativo */}
                    <div className="absolute inset-0 bg-gradient-to-br from-blue-900/20 via-slate-950 to-slate-950 pointer-events-none"></div>

                    <div className="z-10 flex-1 flex flex-col justify-center items-center gap-8">
                        
                        <div className="text-center space-y-2">
                            <div className="w-20 h-20 bg-blue-600 rounded-3xl mx-auto flex items-center justify-center mb-6 shadow-2xl shadow-blue-900/50">
                                <Icon name="scan-barcode" size={40} className="text-white"/>
                            </div>
                            <h1 className="text-3xl font-black tracking-tighter">SCANNER LITE</h1>
                            <p className="text-slate-500 text-xs font-bold tracking-[0.2em] uppercase">Edición Especial Balta</p>
                        </div>

                        {/* Botón Principal */}
                        <div onClick={() => setShowScanner(true)} className="glass-card w-full max-w-xs p-8 rounded-[2.5rem] flex flex-col items-center justify-center gap-6 cursor-pointer hover:bg-white/10 active:scale-95 transition-all group">
                            <div className="text-sky-400 group-hover:text-white transition-colors drop-shadow-[0_0_15px_rgba(56,189,248,0.5)]">
                                <Icon name="camera" size={64}/>
                            </div>
                            <span className="text-xs font-black uppercase tracking-[0.2em] text-slate-300">Iniciar Escáner</span>
                        </div>

                        {/* Info Footer */}
                        <div className="mt-8 flex flex-col gap-2 items-center">
                            <span className="px-4 py-1.5 rounded-full bg-slate-900/80 border border-slate-800 text-[10px] font-bold text-slate-400 uppercase tracking-wider">
                                {statusMsg}
                            </span>
                            {lastSaveCount > 0 && (
                                <span className="text-green-400 text-xs font-bold animate-pulse">
                                    ✓ Último lote: {lastSaveCount} paquetes
                                </span>
                            )}
                        </div>
                    </div>

                    <QuickScannerModal 
                        isVisible={showScanner} 
                        onClose={() => setShowScanner(false)}
                        ordersCache={ordersCache}
                        onScanSaved={setLastSaveCount}
                    />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ScannerG6 />);
    </script>
</body>
</html>