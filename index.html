<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CIRINEO NEXO v5.2 - Vista Previa</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background: #0f172a; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        
        /* Escáner Rectangular 6:1 con Guía Visual */
        #reader { width: 100% !important; border: none !important; }
        #reader video { object-fit: cover !important; height: 120px !important; }

        .scan-frame {
            position: relative;
            width: 100%;
            height: 120px;
            overflow: hidden;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            background: black;
        }

        .laser-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #ff0000;
            box-shadow: 0 0 10px #ff0000;
            top: 50%;
            z-index: 20;
            animation: pulseLaser 1.5s infinite;
        }

        @keyframes pulseLaser { 0%, 100% { opacity: 0.8; } 50% { opacity: 0.3; } }

        /* Estilo de la tabla de vista previa */
        .preview-table { font-size: 0.75rem; width: 100%; }
        .preview-table th { color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; padding: 8px; }
        .preview-table td { padding: 10px 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // CONFIGURACIÓN FIREBASE (Mantén la tuya)
        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // BIBLIOTECA DE ICONOS
        const ICON_LIST = ['user', 'shield', 'star', 'zap', 'camera', 'layers', 'message-square', 'package', 'cpu', 'activity', 'bell', 'coffee', 'anchor', 'heart', 'target', 'box'];

        const Icon = ({ name, size = 20, className }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && lucide.icons[name]) {
                    ref.current.innerHTML = lucide.icons[name].toSvg({ width: size, height: size, class: className });
                }
            }, [name, size, className]);
            return <span ref={ref} className="inline-block leading-none"></span>;
        };

        // --- COMPONENTE: LOGIN ---
        const LoginScreen = ({ onLogin }) => {
            const [pin, setPin] = useState("");
            const handleLogin = async () => {
                if (pin === '13524680') {
                    onLogin({ name: "JVN93", pin: "13524680", role: "admin", icon: "shield", theme: "https://images.unsplash.com/photo-1550745165-9bc0b252726f" });
                    return;
                }
                const doc = await db.collection('users').doc(pin).get();
                if (doc.exists) onLogin(doc.data());
                else alert("Acceso denegado. PIN incorrecto.");
            };
            return (
                <div className="h-screen flex flex-col items-center justify-center bg-slate-950 text-white p-6">
                    <Icon name="cpu" size={60} className="text-cyan-500 mb-6"/>
                    <h1 className="text-2xl font-black tracking-tighter mb-8">CIRINEO NEXO v5.2</h1>
                    <input type="password" value={pin} onChange={e=>setPin(e.target.value)} className="bg-slate-900 border border-slate-700 text-center text-4xl w-full max-w-xs p-5 rounded-3xl mb-6 outline-none focus:border-cyan-500" placeholder="PIN"/>
                    <button onClick={handleLogin} className="bg-cyan-600 hover:bg-cyan-500 w-full max-w-xs py-5 rounded-3xl font-bold transition-all shadow-lg shadow-cyan-900/20">ACCEDER AL NÚCLEO</button>
                </div>
            );
        };

        // --- MÓDULO: ESCÁNER PRO 6:1 ---
        const ScannerModule = ({ user, repoUrl }) => {
            const [isScanning, setIsScanning] = useState(false);
            const [history, setHistory] = useState([]);
            const [papeleta, setPapeleta] = useState(null);
            const lastScan = useRef({ code: '', time: 0 });

            const onScan = async (code) => {
                const now = Date.now();
                const cleanCode = code.trim();

                // 1. Lógica de 3 segundos (Eliminar repetidos automáticos)
                if (cleanCode === lastScan.current.code && (now - lastScan.current.time) < 3000) {
                    return; 
                }

                // 2. Lógica de aviso (Ya escaneada)
                if (cleanCode === lastScan.current.code && (now - lastScan.current.time) >= 3000) {
                    alert(`¡ATENCIÓN! La papeleta ${cleanCode} ya se leyó hace poco. Verifica si es un duplicado.`);
                }

                lastScan.current = { code: cleanCode, time: now };
                new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3').play();

                // 3. Procesar datos para papeleta virtual
                const model = cleanCode.split('-')[0] || 'GENERIC';
                const img = `${repoUrl}${model}.jpg`;
                const record = {
                    codigo_paquete: cleanCode,
                    tejedor: user.name,
                    fecha: firebase.firestore.FieldValue.serverTimestamp(),
                    timestamp_ms: now,
                    modelo: model,
                    imageUrl: img
                };

                await db.collection('registro_produccion').add(record);
                setPapeleta(record);
                setHistory(prev => [record, ...prev].slice(0, 5));
            };

            useEffect(() => {
                let scanner;
                if (isScanning) {
                    scanner = new Html5Qrcode("reader");
                    scanner.start({ facingMode: "environment" }, { fps: 20, qrbox: { width: 350, height: 80 } }, onScan);
                }
                return () => { if(scanner) scanner.stop(); };
            }, [isScanning]);

            return (
                <div className="space-y-4">
                    <div className="scan-frame">
                        <div id="reader"></div>
                        <div className="laser-line"></div>
                    </div>
                    
                    <button onClick={() => setIsScanning(!isScanning)} className={`w-full py-4 rounded-2xl font-bold text-white transition-all ${isScanning ? 'bg-red-500' : 'bg-cyan-600'}`}>
                        {isScanning ? 'DETENER LÁSER' : 'INICIAR ESCÁNER 6:1'}
                    </button>

                    {papeleta && (
                        <div className="bg-white rounded-2xl p-4 flex gap-4 items-center animate-bounce-short shadow-xl">
                            <img src={papeleta.imageUrl} className="w-20 h-20 object-cover rounded-lg border" onError={e=>e.target.src='https://placehold.co/100x100?text=NO+IMG'}/>
                            <div className="flex-1">
                                <div className="text-[10px] text-slate-400 font-bold uppercase">Papeleta Virtual</div>
                                <div className="text-lg font-black text-slate-800 leading-none">{papeleta.modelo}</div>
                                <div className="text-xs font-mono text-slate-500 mt-1">{papeleta.codigo_paquete}</div>
                            </div>
                            <div className="text-green-500"><Icon name="check-circle" size={32}/></div>
                        </div>
                    )}
                </div>
            );
        };

        // --- MÓDULO: VISTA PREVIA CONSOLIDADOR (SOLO LECTURA) ---
        const ConsolidatorPreview = () => {
            const [data, setData] = useState([]);
            useEffect(() => {
                const unsub = db.collection('registro_produccion').orderBy('fecha', 'desc').limit(25).onSnapshot(s => {
                    setData(s.docs.map(d => ({id: d.id, ...d.data()})));
                });
                return () => unsub();
            }, []);

            return (
                <div className="bg-slate-900/50 rounded-2xl overflow-hidden border border-white/10">
                    <div className="p-3 bg-white/5 flex items-center justify-between">
                        <span className="text-xs font-bold text-cyan-400">MONITOR DE PRODUCCIÓN (LECTURA)</span>
                        <div className="flex gap-1">
                            <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                            <div className="w-2 h-2 rounded-full bg-green-500/50"></div>
                        </div>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="preview-table text-white">
                            <thead>
                                <tr className="text-left bg-black/20">
                                    <th>Papeleta</th>
                                    <th>Usuario</th>
                                    <th>Hora</th>
                                </tr>
                            </thead>
                            <tbody>
                                {data.map(item => (
                                    <tr key={item.id} className="opacity-80">
                                        <td className="font-mono text-cyan-300">{item.codigo_paquete}</td>
                                        <td>{item.tejedor}</td>
                                        <td className="text-slate-500">{item.fecha?.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- PANEL JVN93: ADMINISTRACIÓN Y PERSONALIZACIÓN ---
        const AdminPanel = ({ config, setConfig }) => {
            const [users, setUsers] = useState([]);
            const [editUser, setEditUser] = useState(null);

            useEffect(() => {
                db.collection('users').onSnapshot(s => setUsers(s.docs.map(d => ({id: d.id, ...d.data()}))));
            }, []);

            return (
                <div className="space-y-6">
                    <div className="bg-slate-100 p-4 rounded-2xl">
                        <h3 className="text-sm font-bold mb-3 flex items-center gap-2"><Icon name="github"/> Repositorio GitHub</h3>
                        <input value={config.repo || ''} onChange={e=>setConfig({...config, repo: e.target.value})} className="w-full p-3 bg-white border rounded-xl text-sm" placeholder="https://raw.githubusercontent.com/..."/>
                    </div>

                    <div className="grid grid-cols-1 gap-3">
                        {users.map(u => (
                            <div key={u.id} className="bg-white p-4 rounded-2xl flex items-center justify-between border shadow-sm">
                                <div className="flex items-center gap-4">
                                    <div className="w-12 h-12 bg-slate-900 rounded-xl flex items-center justify-center text-cyan-400">
                                        <Icon name={u.icon || 'user'} size={24}/>
                                    </div>
                                    <div>
                                        <div className="font-bold text-slate-800">{u.name}</div>
                                        <div className="text-xs text-slate-400">PIN: {u.pin}</div>
                                    </div>
                                </div>
                                <button onClick={() => setEditUser(u)} className="p-2 bg-slate-100 rounded-full"><Icon name="settings" className="text-slate-500"/></button>
                            </div>
                        ))}
                    </div>

                    {editUser && (
                        <div className="fixed inset-0 bg-black/90 z-[300] flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm p-6 rounded-[2rem] space-y-5">
                                <h2 className="text-xl font-black text-center">PERSONALIZAR</h2>
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase">Fondo de Pantalla (URL)</label>
                                    <input value={editUser.theme} onChange={e=>setEditUser({...editUser, theme: e.target.value})} className="w-full p-3 bg-slate-100 rounded-xl mt-1 text-xs"/>
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase">Icono de Identidad</label>
                                    <div className="grid grid-cols-6 gap-2 mt-2">
                                        {ICON_LIST.map(i => (
                                            <button key={i} onClick={()=>setEditUser({...editUser, icon: i})} className={`p-2 rounded-lg ${editUser.icon === i ? 'bg-cyan-600 text-white' : 'bg-slate-100 text-slate-400'}`}>
                                                <Icon name={i} size={16}/>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={async () => { await db.collection('users').doc(editUser.pin).set(editUser); setEditUser(null); }} className="flex-1 bg-slate-900 text-white py-4 rounded-2xl font-bold">GUARDAR</button>
                                    <button onClick={()=>setEditUser(null)} className="flex-1 bg-slate-200 py-4 rounded-2xl font-bold">CANCELAR</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- APP CORE ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [config, setConfig] = useState({ repo: '' });
            const [modal, setModal] = useState(null);

            useEffect(() => {
                db.collection('settings').doc('global').onSnapshot(d => d.exists && setConfig(d.data()));
            }, []);

            if (!user) return <LoginScreen onLogin={setUser} />;

            return (
                <div className="h-screen w-screen flex flex-col relative overflow-hidden bg-slate-950">
                    <div className="absolute inset-0 z-0 opacity-40 grayscale" style={{backgroundImage: `url(${user.theme})`, backgroundSize: 'cover', backgroundPosition: 'center'}}></div>
                    
                    {/* Header */}
                    <div className="p-5 flex justify-between items-center glass z-10 border-b border-white/10">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-cyan-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-cyan-900/50">
                                <Icon name={user.icon || 'user'} />
                            </div>
                            <div className="leading-none">
                                <div className="text-white font-black text-sm">{user.name}</div>
                                <div className="text-[9px] text-cyan-400 font-bold tracking-widest uppercase">{user.role}</div>
                            </div>
                        </div>
                        <button onClick={() => setUser(null)} className="p-2 text-red-400 hover:bg-red-500/10 rounded-full transition-all"><Icon name="log-out"/></button>
                    </div>

                    {/* Dashboard */}
                    <div className="flex-1 p-6 z-10 grid grid-cols-2 gap-4 content-start overflow-y-auto">
                        <MenuCard label="Scanner" icon="camera" color="bg-cyan-500" onClick={() => setModal('scanner')} />
                        <MenuCard label="Monitor" icon="layers" color="bg-indigo-500" onClick={() => setModal('preview')} />
                        <MenuCard label="Calculadora" icon="cpu" color="bg-emerald-500" onClick={() => setModal('calc')} />
                        <MenuCard label="Chat" icon="message-square" color="bg-blue-500" onClick={() => setModal('chat')} />
                        
                        {user.pin === '13524680' && (
                            <div className="col-span-2 mt-4">
                                <button onClick={() => setModal('admin')} className="w-full p-4 glass rounded-3xl border-rose-500/30 flex items-center justify-center gap-3 text-rose-400 font-bold">
                                    <Icon name="shield" size={20}/> PANEL JVN93
                                </button>
                            </div>
                        }
                    </div>

                    {/* Modales Dinámicos */}
                    {modal && (
                        <div className="fixed inset-0 z-50 bg-slate-950/95 flex flex-col p-4 animate-fade-in">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-white font-black text-lg flex items-center gap-2">
                                    <Icon name="target" className="text-cyan-500"/> {modal.toUpperCase()}
                                </h2>
                                <button onClick={()=>setModal(null)} className="p-3 bg-white/10 rounded-2xl text-white"><Icon name="x"/></button>
                            </div>
                            <div className="flex-1 overflow-y-auto">
                                {modal === 'scanner' && <ScannerModule user={user} repoUrl={config.repo} />}
                                {modal === 'preview' && <ConsolidatorPreview />}
                                {modal === 'admin' && <AdminPanel config={config} setConfig={(c) => { setConfig(c); db.collection('settings').doc('global').set(c); }} />}
                                {modal === 'calc' && <div className="text-slate-500 text-center py-20 font-bold italic">Cargando calculadora del sistema...</div>}
                                {modal === 'chat' && <div className="text-slate-500 text-center py-20 font-bold italic">Conectando con el servidor de chat...</div>}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const MenuCard = ({ label, icon, color, onClick }) => (
            <button onClick={onClick} className="flex flex-col items-center gap-3 p-6 glass rounded-[2.5rem] border-white/5 active:scale-90 transition-all">
                <div className={`${color} p-4 rounded-2xl shadow-2xl`}>
                    <Icon name={icon} size={30} className="text-white" />
                </div>
                <span className="text-white text-[10px] font-black uppercase tracking-widest">{label}</span>
            </button>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
