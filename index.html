<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CIRINEO NEXO v5.1 - Máscara Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background: #0f172a; font-family: 'Segoe UI', sans-serif; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        
        /* CONTENEDOR DE CÁMARA TOTAL */
        .scan-viewport {
            position: relative;
            width: 100%;
            height: 350px; /* Altura generosa para ver la cámara */
            background: black;
            border-radius: 20px;
            overflow: hidden;
        }

        #reader { width: 100% !important; height: 100% !important; border: none !important; }
        #reader video { object-fit: cover !important; height: 100% !important; }

        /* CAPA DE RED (OSCURECIMIENTO CON HUECO 6:1) */
        .scanner-overlay {
            position: absolute;
            inset: 0;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .focus-rect {
            width: 90%;
            aspect-ratio: 6/1;
            border: 2px solid #3b82f6;
            border-radius: 4px;
            position: relative;
            /* Truco de la sombra gigante para oscurecer el resto */
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.7);
        }

        .laser-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #f87171;
            box-shadow: 0 0 10px #ef4444;
            animation: scanAnim 2s infinite ease-in-out;
        }

        @keyframes scanAnim {
            0%, 100% { top: 0%; opacity: 0.5; }
            50% { top: 100%; opacity: 1; }
        }

        .user-theme-bg { background-size: cover; background-position: center; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const ICON_LIBRARY = ['user', 'settings', 'camera', 'layers', 'message-square', 'star', 'zap', 'shield', 'package', 'truck', 'activity'];

        const Icon = ({ name, size = 24, className }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && lucide.icons[name]) {
                    ref.current.innerHTML = lucide.icons[name].toSvg({ width: size, height: size, class: className });
                }
            }, [name, size, className]);
            return <span ref={ref} className="inline-block"></span>;
        };

        const LoginScreen = ({ onLogin }) => {
            const [pin, setPin] = useState("");
            const handleLogin = async () => {
                if (pin === '13524680') {
                    onLogin({ name: "JVN93", pin: "13524680", role: "admin", icon: "shield", theme: "https://images.unsplash.com/photo-1614850523296-d8c1af93d400" });
                    return;
                }
                const snap = await db.collection('users').doc(pin).get();
                if (snap.exists) onLogin(snap.data());
                else alert("PIN incorrecto.");
            };
            return (
                <div className="h-screen flex flex-col items-center justify-center p-6 bg-slate-900 text-white">
                    <Icon name="cpu" size={64} className="mb-4 text-blue-500"/>
                    <h1 className="text-2xl font-black mb-8 tracking-tighter text-center">CIRINEO NEXO<br/><span className="text-blue-500">PRODUCCIÓN</span></h1>
                    <input type="password" value={pin} onChange={e=>setPin(e.target.value)} className="bg-slate-800 text-center text-4xl w-64 p-4 rounded-2xl border border-slate-700 mb-6 outline-none focus:border-blue-500" placeholder="PIN"/>
                    <button onClick={handleLogin} className="bg-blue-600 w-64 py-4 rounded-2xl font-bold active:scale-95 transition-transform">ENTRAR</button>
                </div>
            );
        };

        const ScannerModule = ({ user }) => {
            const [scannedList, setScannedList] = useState([]);
            const [isScanning, setIsScanning] = useState(false);
            const lastScanData = useRef({ code: '', time: 0 });

            const processScan = async (decodedText) => {
                const now = Date.now();
                const code = decodedText.trim();
                if (code === lastScanData.current.code && (now - lastScanData.current.time) < 3000) return;
                
                if (code === lastScanData.current.code && (now - lastScanData.current.time) >= 3000) {
                    alert(`Papeleta repetida: ${code}`);
                }

                lastScanData.current = { code, time: now };
                new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3').play();

                const record = {
                    codigo_paquete: code,
                    tejedor: user.name,
                    fecha: firebase.firestore.FieldValue.serverTimestamp(),
                    timestamp_ms: now,
                    dispositivo: "Nexo Scanner"
                };

                await db.collection('registro_produccion').add(record);
                setScannedList(prev => [record, ...prev].slice(0, 5));
            };

            useEffect(() => {
                let html5QrCode;
                if (isScanning) {
                    html5QrCode = new Html5Qrcode("reader");
                    html5QrCode.start(
                        { facingMode: "environment" },
                        { fps: 25, qrbox: { width: 320, height: 54 } },
                        processScan
                    );
                }
                return () => { if(html5QrCode) html5QrCode.stop().catch(() => {}); };
            }, [isScanning]);

            return (
                <div className="space-y-4">
                    <div className="scan-viewport">
                        <div id="reader"></div>
                        <div className="scanner-overlay">
                            <div className="focus-rect">
                                <div className="laser-line"></div>
                            </div>
                        </div>
                    </div>

                    <button onClick={() => setIsScanning(!isScanning)} className={`w-full py-5 rounded-2xl font-black text-xl text-white ${isScanning ? 'bg-red-500 shadow-lg shadow-red-900/40' : 'bg-blue-600 shadow-lg shadow-blue-900/40'}`}>
                        {isScanning ? 'DETENER LÁSER' : 'INICIAR CÁMARA'}
                    </button>

                    <div className="bg-black/40 rounded-2xl p-4 h-40 overflow-y-auto border border-white/5">
                        <h4 className="text-[10px] font-black text-slate-500 mb-2 uppercase tracking-widest">Últimos Registros</h4>
                        {scannedList.map((s, i) => (
                            <div key={i} className="flex justify-between items-center py-2 border-b border-white/5 animate-pulse">
                                <span className="text-blue-400 font-mono text-sm font-bold">{s.codigo_paquete}</span>
                                <span className="text-[10px] text-slate-500">{new Date(s.timestamp_ms).toLocaleTimeString()}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [modal, setModal] = useState(null);

            if (!user) return <LoginScreen onLogin={setUser} />;

            return (
                <div className="h-screen w-screen user-theme-bg overflow-hidden flex flex-col" style={{ backgroundImage: `linear-gradient(rgba(15,23,42,0.85), rgba(15,23,42,0.85)), url(${user.theme})` }}>
                    <div className="p-4 flex justify-between items-center glass border-b border-white/10">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg">
                                <Icon name={user.icon || 'user'} />
                            </div>
                            <span className="text-white font-bold">{user.name}</span>
                        </div>
                        <button onClick={() => setUser(null)} className="p-2 text-red-400 bg-red-400/10 rounded-lg"><Icon name="log-out" size={20}/></button>
                    </div>

                    <div className="flex-1 p-6 grid grid-cols-2 gap-4 content-start">
                        <MenuBtn label="Escáner" icon="camera" color="bg-blue-500" onClick={() => setModal('scanner')} />
                        <MenuBtn label="Mensajes" icon="message-square" color="bg-green-500" />
                        <MenuBtn label="Cálculo" icon="cpu" color="bg-purple-500" />
                        <MenuBtn label="Reportes" icon="layers" color="bg-amber-500" />
                    </div>

                    {modal === 'scanner' && (
                        <div className="fixed inset-0 z-50 bg-slate-950 flex flex-col p-4 animate-in slide-in-from-bottom duration-300">
                            <div className="flex justify-between items-center mb-4 text-white">
                                <h2 className="font-black uppercase tracking-widest text-blue-500">MODO LÁSER</h2>
                                <button onClick={()=>setModal(null)} className="p-3 bg-white/5 rounded-2xl border border-white/10"><Icon name="x"/></button>
                            </div>
                            <ScannerModule user={user} />
                        </div>
                    )}
                </div>
            );
        };

        const MenuBtn = ({ label, icon, color, onClick }) => (
            <button onClick={onClick} className="flex flex-col items-center gap-3 p-6 glass rounded-[2.5rem] active:scale-90 transition-all border border-white/5 shadow-xl">
                <div className={`${color} p-4 rounded-2xl shadow-lg`}>
                    <Icon name={icon} size={32} className="text-white" />
                </div>
                <span className="text-white text-[10px] font-black uppercase tracking-widest opacity-60">{label}</span>
            </button>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
