<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consolidador - Cirineo (iPad Legacy)</title>
    
    <link rel="icon" href="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/refs/heads/main/icon.ico">
    
    <script src="https://unpkg.com/core-js-bundle@3.32.0/index.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@0.263.0"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        body { background-color: #f1f5f9; color: #1e293b; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .card-enter { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Scrollbar compatible */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Compatibilidad de Hooks para React 17
        var useState = React.useState;
        var useEffect = React.useEffect;
        var useMemo = React.useMemo;

        var firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        var db = firebase.firestore();

        // Componente Icono con fallback para Lucide antiguo
        var Icon = function(props) {
            var containerRef = React.useRef(null);
            useEffect(function() {
                if (containerRef.current) {
                    containerRef.current.innerHTML = '';
                    var iconName = props.name.replace(/-([a-z])/g, function (g) { return g[1].toUpperCase(); });
                    var lucideIcon = lucide[props.name] || lucide[iconName];
                    if (lucideIcon) {
                        var svg = lucideIcon.toSvg({ 
                            width: props.size || 18, 
                            height: props.size || 18, 
                            class: props.className 
                        });
                        containerRef.current.innerHTML = svg;
                    }
                }
            }, [props.name, props.size, props.className]);
            return <span ref={containerRef} className="inline-flex items-center justify-center"></span>;
        };

        var ScanCard = function(props) {
            var scan = props.scan;
            var isArchived = props.isArchived;
            
            var containerClasses = isArchived 
                ? "bg-slate-300 border-l-4 border-slate-400 rounded p-3 mb-3 flex flex-col gap-2 relative text-slate-500 opacity-80" 
                : "bg-slate-800 border-l-4 border-indigo-500 rounded p-3 mb-3 shadow-lg card-enter flex flex-col gap-2 relative text-white";

            return (
                <div className={containerClasses}>
                    {props.processing === scan.id && <div className="absolute inset-0 bg-black/60 z-10 flex items-center justify-center"><div className="w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin"></div></div>}
                    <div className="flex justify-between items-start">
                        <div className="bg-indigo-900/50 text-[10px] font-mono px-2 py-0.5 rounded border border-indigo-700/50">{scan.codigo_paquete}</div>
                        <div className="text-[10px] font-mono text-right flex items-center gap-1">
                            <Icon name={isArchived ? "archive" : "clock"} size={10}/> {scan.fecha_scan || '---'}
                        </div>
                    </div>
                    <div>
                        <div className="font-bold text-lg leading-tight">{scan.modelo}</div>
                        <div className="text-xs font-bold text-yellow-400">{scan.partida}</div>
                    </div>
                    {!isArchived && (
                        <div className="grid grid-cols-2 gap-2 mt-2">
                            <button onClick={function() { props.onDelete(scan) }} className="bg-slate-700 p-2 rounded flex items-center justify-center gap-1 text-[10px] font-bold">
                                <Icon name="x" size={14}/> DESCARTAR
                            </button>
                            <button onClick={function() { props.onApprove(scan) }} className="bg-green-600 p-2 rounded flex items-center justify-center gap-1 text-[10px] font-bold">
                                <Icon name="check" size={14}/> APROBAR
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        var MachineColumn = function(props) {
            return (
                <div className="min-w-[280px] max-w-[280px] flex flex-col h-full bg-slate-200/50 border border-slate-300 rounded-lg overflow-hidden mr-4">
                    <div className="p-3 bg-white border-b flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            <div className="bg-slate-800 w-7 h-7 rounded flex items-center justify-center font-black text-white text-xs">{props.machineId}</div>
                            <span className="font-bold text-slate-700 text-xs">MÁQUINA</span>
                        </div>
                        <span className="text-[10px] font-bold bg-indigo-100 px-2 py-1 rounded-full">{props.pendingScans.length} PEND.</span>
                    </div>
                    <div className="p-2 overflow-y-auto flex-1">
                        {props.pendingScans.map(function(scan) { 
                            return <ScanCard key={scan.id} scan={scan} onApprove={props.onApprove} onDelete={props.onDelete} processing={props.processingId} isArchived={false} /> 
                        })}
                    </div>
                </div>
            );
        };

        var App = function() {
            var [scannedItems, setScannedItems] = useState([]);
            var [orders, setOrders] = useState([]);
            var [approvedIds, setApprovedIds] = useState(new Set());
            var [processingId, setProcessingId] = useState(null);

            useEffect(function() {
                var unsub1 = db.collection('orders').where('status', '!=', 'ARCHIVADO').onSnapshot(function(snap) {
                    setOrders(snap.docs.map(function(d) { return Object.assign({}, d.data(), {id: d.id}); }));
                });
                var unsub2 = db.collection('registro_produccion').onSnapshot(function(snap) {
                    setScannedItems(snap.docs.map(function(d) { return Object.assign({}, d.data(), {id: d.id}); }));
                });
                var unsub3 = db.collection('registros_aprobados').onSnapshot(function(snap) {
                    var ids = new Set();
                    snap.docs.forEach(function(d) { ids.add(d.id); });
                    setApprovedIds(ids);
                });
                return function() { unsub1(); unsub2(); unsub3(); };
            }, []);

            var groups = useMemo(function() {
                var m = {};
                scannedItems.forEach(function(scan) {
                    if (approvedIds.has(scan.id)) return;
                    var order = orders.find(function(o) { return String(o.id) === String(scan.orderId); });
                    var mq = (order && order.maquina) ? order.maquina : "S/N";
                    if (!m[mq]) m[mq] = [];
                    m[mq].push(scan);
                });
                return m;
            }, [scannedItems, orders, approvedIds]);

            var handleApprove = async function(scanItem) {
                setProcessingId(scanItem.id);
                try {
                    var orderDocRef = db.collection('orders').doc(String(scanItem.orderId));
                    var orderSnap = await orderDocRef.get();
                    if (!orderSnap.exists) throw new Error("No existe la orden");
                    
                    var orderData = orderSnap.data();
                    var updatedProgreso = orderData.progreso.map(function(p) {
                        if (p.paqueteNum === parseInt(scanItem.paquete_indice)) {
                            return Object.assign({}, p, { finished: true, fecha: new Date().toISOString() });
                        }
                        return p;
                    });

                    await orderDocRef.update({ progreso: updatedProgreso });
                    await db.collection('registros_aprobados').doc(scanItem.id).set(scanItem);
                } catch (e) { alert(e.message); }
                setProcessingId(null);
            };

            var handleDelete = async function(scanItem) {
                if(!confirm("¿Eliminar?")) return;
                try { await db.collection('registro_produccion').doc(scanItem.id).delete(); } catch(e) {}
            };

            return (
                <div className="h-screen flex flex-col bg-slate-100">
                    <header className="bg-white border-b p-4 flex justify-between items-center">
                        <h1 className="text-lg font-black text-slate-800">CONSOLIDADOR CIRINEO</h1>
                        <div className="text-[10px] font-bold bg-slate-800 text-white px-3 py-1 rounded">iOS 10 COMPATIBLE</div>
                    </header>
                    <div className="flex-1 overflow-x-auto p-4 flex items-start">
                        {Object.keys(groups).map(function(mq) {
                            return <MachineColumn key={mq} machineId={mq} pendingScans={groups[mq]} onApprove={handleApprove} onDelete={handleDelete} processingId={processingId} />
                        })}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
