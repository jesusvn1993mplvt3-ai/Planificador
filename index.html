<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CIRINEO NEXO v5.0</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background: #0f172a; font-family: 'Segoe UI', sans-serif; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        
        /* Escáner Rectangular 6:1 */
        #reader { width: 100% !important; border: none !important; }
        #reader__scan_region { background: white !important; }
        #reader video { object-fit: cover !important; height: 120px !important; }

        .scan-container {
            position: relative;
            width: 100%;
            height: 120px; /* Proporción aproximada 6:1 en móviles */
            overflow: hidden;
            border: 4px solid #3b82f6;
            border-radius: 12px;
        }

        .scan-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #ef4444;
            box-shadow: 0 0 15px 2px #ef4444;
            animation: scanAnim 2s infinite;
            z-index: 10;
        }

        @keyframes scanAnim {
            0% { top: 0%; }
            50% { top: 100%; }
            100% { top: 0%; }
        }

        .user-theme-bg { background-size: cover; background-position: center; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // CONFIGURACIÓN FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // BIBLIOTECA DE ICONOS PARA PERSONALIZACIÓN
        const ICON_LIBRARY = [
            'user', 'settings', 'camera', 'layers', 'message-square', 'star', 'zap', 
            'shield', 'cpu', 'package', 'truck', 'activity', 'bell', 'heart', 'anchor', 'coffee'
        ];

        const Icon = ({ name, size = 24, className }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && lucide.icons[name]) {
                    ref.current.innerHTML = lucide.icons[name].toSvg({ width: size, height: size, class: className });
                }
            }, [name, size, className]);
            return <span ref={ref} className="inline-block"></span>;
        };

        // --- COMPONENTE: LOGIN ---
        const LoginScreen = ({ onLogin }) => {
            const [pin, setPin] = useState("");
            const handleLogin = async () => {
                if (pin === '13524680') {
                    onLogin({ name: "JVN93", pin: "13524680", role: "admin", icon: "shield", theme: "https://images.unsplash.com/photo-1614850523296-d8c1af93d400" });
                    return;
                }
                const snap = await db.collection('users').doc(pin).get();
                if (snap.exists) onLogin(snap.data());
                else alert("PIN incorrecto o usuario no configurado.");
            };
            return (
                <div className="h-screen flex flex-col items-center justify-center p-6 bg-slate-900 text-white">
                    <Icon name="cpu" size={64} className="mb-4 text-blue-500"/>
                    <h1 className="text-2xl font-black mb-8 tracking-tighter">CIRINEO NEXO v5</h1>
                    <input type="password" value={pin} onChange={e=>setPin(e.target.value)} className="bg-slate-800 text-center text-4xl w-64 p-4 rounded-2xl border border-slate-700 mb-6" placeholder="PIN"/>
                    <button onClick={handleLogin} className="bg-blue-600 w-64 py-4 rounded-2xl font-bold">ENTRAR</button>
                </div>
            );
        };

        // --- COMPONENTE: SCANNER 6:1 (CONECTADO AL CONSOLIDADOR) ---
        const ScannerModule = ({ user }) => {
            const [scannedList, setScannedList] = useState([]);
            const [isScanning, setIsScanning] = useState(false);
            const lastScanData = useRef({ code: '', time: 0 });

            const processScan = async (decodedText) => {
                const now = Date.now();
                const code = decodedText.trim();

                // Lógica de 3 segundos
                if (code === lastScanData.current.code && (now - lastScanData.current.time) < 3000) {
                    console.log("Duplicado ignorado (menos de 3s)");
                    return; 
                }

                // Verificar si ya existe en la lista actual (Prevención de errores)
                if (code === lastScanData.current.code && (now - lastScanData.current.time) >= 3000) {
                    alert(`OJO: La papeleta ${code} ya fue escaneada hace un momento. ¡Verifica!`);
                }

                lastScanData.current = { code: code, time: now };

                // Sonido
                new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3').play();

                // Registro para el Consolidador Original
                const nuevoRegistro = {
                    codigo_paquete: code,
                    tejedor: user.name,
                    fecha: firebase.firestore.FieldValue.serverTimestamp(),
                    timestamp_ms: now,
                    dispositivo: "Nexo Scanner"
                };

                await db.collection('registro_produccion').add(nuevoRegistro);
                setScannedList(prev => [nuevoRegistro, ...prev].slice(0, 10));
            };

            useEffect(() => {
                let html5QrCode;
                if (isScanning) {
                    html5QrCode = new Html5Qrcode("reader");
                    html5QrCode.start(
                        { facingMode: "environment" },
                        { fps: 20, qrbox: { width: 400, height: 80 } }, // Forzado de área ancha
                        processScan
                    );
                }
                return () => { if(html5QrCode) html5QrCode.stop(); };
            }, [isScanning]);

            return (
                <div className="space-y-4">
                    <div className="scan-container">
                        <div id="reader"></div>
                        <div className="scan-line"></div>
                    </div>

                    <button onClick={() => setIsScanning(!isScanning)} className={`w-full py-4 rounded-xl font-bold text-white ${isScanning ? 'bg-red-500' : 'bg-blue-600'}`}>
                        {isScanning ? 'APAGAR CÁMARA' : 'ENCENDER ESCÁNER'}
                    </button>

                    <div className="bg-white/5 rounded-xl p-4 h-48 overflow-y-auto">
                        <h4 className="text-xs font-bold text-slate-400 mb-2 uppercase">Sesión de {user.name}</h4>
                        {scannedList.map((s, i) => (
                            <div key={i} className="flex justify-between items-center py-2 border-b border-white/10">
                                <span className="text-green-400 font-mono text-sm">{s.codigo_paquete}</span>
                                <span className="text-[10px] text-slate-500">{new Date(s.timestamp_ms).toLocaleTimeString()}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- PANEL JVN93: PERSONALIZACIÓN Y REPOS ---
        const AdminModule = ({ config, setConfig }) => {
            const [users, setUsers] = useState([]);
            const [editingUser, setEditingUser] = useState(null);

            useEffect(() => {
                db.collection('users').onSnapshot(s => setUsers(s.docs.map(d => ({id: d.id, ...d.data()}))));
            }, []);

            const saveUser = async (u) => {
                await db.collection('users').doc(u.pin).set(u);
                setEditingUser(null);
            };

            return (
                <div className="space-y-6">
                    <div className="bg-slate-800 p-4 rounded-xl">
                        <h3 className="font-bold text-white mb-4">Configuración de Repositorio</h3>
                        <input value={config.repo || ''} onChange={e=>setConfig({...config, repo: e.target.value})} className="w-full p-2 rounded bg-slate-700 text-white border-none" placeholder="URL de imágenes GitHub..."/>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {users.map(u => (
                            <div key={u.id} className="bg-white p-4 rounded-xl flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="p-2 bg-blue-100 rounded-lg text-blue-600">
                                        <Icon name={u.icon || 'user'} />
                                    </div>
                                    <div>
                                        <div className="font-bold">{u.name}</div>
                                        <div className="text-xs text-slate-400">PIN: {u.pin}</div>
                                    </div>
                                </div>
                                <button onClick={() => setEditingUser(u)} className="p-2 text-slate-400 hover:text-blue-600"><Icon name="settings" size={20}/></button>
                            </div>
                        ))}
                    </div>

                    {editingUser && (
                        <div className="fixed inset-0 bg-black/80 z-[200] flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-md p-6 rounded-3xl space-y-4">
                                <h2 className="text-xl font-bold">Personalizar: {editingUser.name}</h2>
                                <input placeholder="Imagen de Fondo (URL)" value={editingUser.theme} onChange={e=>setEditingUser({...editingUser, theme: e.target.value})} className="w-full p-2 border rounded"/>
                                
                                <div>
                                    <label className="text-xs font-bold block mb-2">Icono de Usuario:</label>
                                    <div className="flex flex-wrap gap-2">
                                        {ICON_LIBRARY.map(ico => (
                                            <button key={ico} onClick={()=>setEditingUser({...editingUser, icon: ico})} className={`p-2 rounded ${editingUser.icon === ico ? 'bg-blue-600 text-white' : 'bg-slate-100'}`}>
                                                <Icon name={ico} size={18}/>
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <div className="flex gap-2 pt-4">
                                    <button onClick={() => saveUser(editingUser)} className="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold">Guardar</button>
                                    <button onClick={() => setEditingUser(null)} className="flex-1 bg-slate-100 py-2 rounded-lg">Cancelar</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [config, setConfig] = useState({ repo: '' });
            const [modal, setModal] = useState(null);

            useEffect(() => {
                db.collection('settings').doc('global').onSnapshot(d => d.exists && setConfig(d.data()));
            }, []);

            if (!user) return <LoginScreen onLogin={setUser} />;

            return (
                <div className="h-screen w-screen user-theme-bg overflow-hidden flex flex-col" style={{ backgroundImage: `linear-gradient(rgba(15,23,42,0.8), rgba(15,23,42,0.8)), url(${user.theme})` }}>
                    
                    {/* Header */}
                    <div className="p-4 flex justify-between items-center glass border-b border-white/10">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white">
                                <Icon name={user.icon || 'user'} />
                            </div>
                            <span className="text-white font-bold">{user.name}</span>
                        </div>
                        <button onClick={() => setUser(null)} className="text-red-400"><Icon name="log-out"/></button>
                    </div>

                    {/* Dashboard */}
                    <div className="flex-1 p-6 grid grid-cols-2 gap-4 content-start">
                        <MenuBtn label="Escáner" icon="camera" color="bg-blue-500" onClick={() => setModal('scanner')} />
                        <MenuBtn label="Chat" icon="message-square" color="bg-green-500" onClick={() => setModal('chat')} />
                        <MenuBtn label="Calculadora" icon="cpu" color="bg-purple-500" onClick={() => setModal('calc')} />
                        <MenuBtn label="Notas" icon="layers" color="bg-amber-500" onClick={() => setModal('notes')} />
                        
                        {user.pin === '13524680' && (
                            <MenuBtn label="JVN93 Admin" icon="settings" color="bg-rose-600" onClick={() => setModal('admin')} />
                        )}
                    </div>

                    {/* Modales */}
                    {modal && (
                        <div className="fixed inset-0 z-50 bg-black/90 flex flex-col p-4 animate-fade-in">
                            <div className="flex justify-between items-center mb-4 text-white">
                                <h2 className="font-bold uppercase tracking-widest">{modal}</h2>
                                <button onClick={()=>setModal(null)} className="p-2 bg-white/10 rounded-full"><Icon name="x"/></button>
                            </div>
                            <div className="flex-1 overflow-y-auto bg-slate-900/50 rounded-3xl p-4 border border-white/10">
                                {modal === 'scanner' && <ScannerModule user={user} />}
                                {modal === 'admin' && <AdminModule config={config} setConfig={(c) => { setConfig(c); db.collection('settings').doc('global').set(c); }} />}
                                {modal === 'calc' && <div className="text-white text-center py-10">Calculadora Estándar</div>}
                                {modal === 'notes' && <div className="text-white text-center py-10">Módulo de Notas</div>}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const MenuBtn = ({ label, icon, color, onClick }) => (
            <button onClick={onClick} className="flex flex-col items-center gap-2 p-4 glass rounded-3xl active:scale-95 transition-all">
                <div className={`${color} p-4 rounded-2xl shadow-lg shadow-black/50`}>
                    <Icon name={icon} size={32} className="text-white" />
                </div>
                <span className="text-white text-[10px] font-black uppercase tracking-tighter">{label}</span>
            </button>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

