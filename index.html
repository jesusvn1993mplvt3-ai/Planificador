<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Balta Scan v16</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        body { margin: 0; background: #020617; font-family: sans-serif; color: white; overflow: hidden; }
        #reader { width: 100% !important; border: none !important; }
        #reader video { object-fit: cover !important; width: 100% !important; height: 300px !important; border-radius: 24px; }
        .scan-container { border: 4px solid #3b82f6; border-radius: 28px; overflow: hidden; position: relative; background: #000; }
        .status-bar { text-transform: uppercase; letter-spacing: 0.1em; font-size: 10px; font-weight: 800; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const firebaseConfig = { 
            apiKey: "AIzaSyCngQL1pdqghv2vbjkPycT1Xf0C46f7jYs", 
            authDomain: "cirineo-cec21.firebaseapp.com", 
            projectId: "cirineo-cec21", 
            storageBucket: "cirineo-cec21.firebasestorage.app", 
            messagingSenderId: "620210618284", 
            appId: "1:620210618284:web:482bab9bf74650fff18409" 
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const App = () => {
            const [active, setActive] = useState(false);
            const [pending, setPending] = useState(null);
            const [msg, setMsg] = useState("Esperando inicio...");
            const [kits, setKits] = useState([]);
            const [orders, setOrders] = useState([]);
            const scannerRef = useRef(null);

            useEffect(() => {
                db.collection('kits_produccion').onSnapshot(s => setKits(s.docs.map(d => d.data())));
                db.collection('orders').onSnapshot(s => setOrders(s.docs.map(d => ({id: d.id, ...d.data()}))));
            }, []);

            const startScan = async () => {
                setActive(true);
                setMsg("Iniciando cámara...");
                setTimeout(() => {
                    const html5QrCode = new Html5Qrcode("reader");
                    scannerRef.current = html5QrCode;
                    html5QrCode.start(
                        { facingMode: "environment" },
                        { fps: 20, qrbox: { width: 250, height: 250 } },
                        (text) => {
                            // Al detectar código, detenemos temporalmente la lectura
                            handleRead(text.trim());
                        }
                    ).catch(err => setMsg("Error: " + err));
                }, 500);
            };

            const handleRead = (code) => {
                const raw = code.toUpperCase();
                // Buscar si es Kit o Individual
                if (raw.startsWith('K')) {
                    const foundKit = kits.find(k => k.kitId === raw);
                    if (foundKit) {
                        setPending({ type: 'KIT', data: foundKit });
                    } else { setMsg("❌ KIT NO ENCONTRADO"); }
                } else {
                    let foundItem = null;
                    orders.forEach(o => {
                        const match = o.progreso?.find(p => p.codigoUnico === raw);
                        if (match) foundItem = { ...match, orderId: o.id, modelo: o.codigo, partida: o.partida };
                    });
                    if (foundItem) {
                        setPending({ type: 'INDV', data: foundItem });
                    } else { setMsg("❌ PAQUETE NO ENCONTRADO"); }
                }
            };

            const confirmUpload = async () => {
                const batch = db.batch();
                const now = firebase.firestore.FieldValue.serverTimestamp();
                
                if (pending.type === 'KIT') {
                    pending.data.piezas.forEach(p => {
                        batch.set(db.collection('registro_produccion').doc(), {
                            code: p.codigoUnico, modelo: pending.data.modelo, orderId: p.orderId,
                            partida: pending.data.partida, paquete_indice: p.paqueteNum,
                            tejedor: "Balta Scan", fecha: now, kitId: pending.data.kitId,
                            maquina: p.maquina || 'SN', finished: false
                        });
                    });
                } else {
                    const p = pending.data;
                    batch.set(db.collection('registro_produccion').doc(), {
                        code: p.codigoUnico, modelo: p.modelo, orderId: p.orderId,
                        partida: p.partida, paquete_indice: p.paqueteNum,
                        tejedor: "Balta Scan", fecha: now, maquina: p.maquina || 'SN', finished: false
                    });
                }

                await batch.commit();
                setPending(null);
                setMsg("✅ REGISTRADO CORRECTAMENTE");
                setTimeout(() => setMsg("Listo para siguiente..."), 2000);
            };

            return (
                <div className="p-6 h-screen flex flex-col">
                    {!active ? (
                        <div className="flex-1 flex flex-col items-center justify-center gap-6">
                            <img src="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/Planificador/refs/heads/main/Balta.png" className="w-40" />
                            <button onClick={startScan} className="w-full bg-blue-600 py-10 rounded-[2.5rem] font-black text-2xl shadow-2xl">ENCENDER CÁMARA</button>
                        </div>
                    ) : (
                        <div className="flex-1 flex flex-col">
                            <div className="scan-container">
                                <div id="reader"></div>
                            </div>
                            
                            <div className="mt-4 p-3 bg-slate-900 rounded-xl border border-slate-800 text-center">
                                <span className="status-bar text-blue-400">{msg}</span>
                            </div>

                            {pending && (
                                <div className="mt-4 flex-1 bg-white rounded-3xl p-6 text-slate-900 flex flex-col justify-between shadow-2xl">
                                    <div>
                                        <h2 className="text-[10px] font-black text-blue-600 uppercase tracking-widest">Confirmar Envío</h2>
                                        <p className="text-3xl font-black leading-none mt-1">{pending.type === 'KIT' ? pending.data.kitId : pending.data.codigoUnico}</p>
                                        <p className="text-xl font-bold text-slate-500">{pending.data.modelo}</p>
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-4">
                                        <button onClick={() => setPending(null)} className="bg-slate-100 py-5 rounded-2xl font-black text-slate-400">DESCARTAR</button>
                                        <button onClick={confirmUpload} className="bg-blue-600 py-5 rounded-2xl font-black text-white text-xl animate-pulse">ENVIAR</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
