<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Viry Control - Conectado</title>
    
    <meta name="theme-color" content="#fdf2f8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3556/3556696.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Quicksand:wght@400;700&family=Montserrat:wght@400;900&display=swap" rel="stylesheet">

    <style>
        body { margin: 0; overflow: hidden; transition: background 0.5s ease; font-family: 'Quicksand', sans-serif; }
        .font-hand { font-family: 'Dancing Script', cursive; }
        .font-bold-modern { font-family: 'Montserrat', sans-serif; }
        
        .scan-wrapper { width: 100%; height: 280px; border-radius: 24px; position: relative; overflow: hidden; background: #000; }
        #reader video { object-fit: cover; width: 100% !important; height: 100% !important; border-radius: 20px; }
        
        @keyframes pulse-pink {
            0%, 100% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(236, 72, 153, 0); }
        }
        .pulse-btn { animation: pulse-pink 2s infinite; }

        .split-container { display: flex; flex-direction: column; height: 100vh; width: 100vw; }
        .split-section { flex: 1; position: relative; overflow: hidden; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
        .split-section:active { transform: scale(0.98); }
        
        /* Chat Animations */
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .chat-panel { animation: slideUp 0.3s ease-out; }

        @media (min-width: 768px) { .split-container { flex-direction: row; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CONFIGURACI√ìN FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCngQL1pdqghv2vbjkPycT1Xf0C46f7jYs",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- SONIDOS ---
        const SOUND_SUCCESS = new Audio("https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3");
        const SOUND_ERROR = new Audio("https://assets.mixkit.co/active_storage/sfx/944/944-preview.mp3");
        const SOUND_MSG = new Audio("https://assets.mixkit.co/active_storage/sfx/2345/2345-preview.mp3"); // Sonido notificaci√≥n

        // ==========================================
        // COMPONENTES COMUNES
        // ==========================================
        const Icon = ({ name, size = 24, className }) => {
            const r = useRef(null);
            useEffect(() => { 
                if (r.current && lucide.icons[name]) 
                    r.current.innerHTML = lucide.icons[name].toSvg({ width: size, height: size }); 
            }, [name, size]);
            return <span ref={r} className={`inline-flex items-center justify-center ${className}`}/>;
        };

        const CloseButton = ({ onClick, dark = false }) => (
            <button onClick={onClick} className={`relative w-10 h-10 flex items-center justify-center rounded-full border z-50 transition-all ${dark ? 'bg-black/20 border-white/20 text-white' : 'bg-pink-100 border-pink-300 text-pink-600'}`}>
                <Icon name="x" size={20} />
            </button>
        );

        // ==========================================
        // CHAT BIDIRECCIONAL (VIRY <-> BALTA)
        // ==========================================
        const WorkChat = ({ isOpen, onClose, user = "Viry", target = "Balta", theme = "light", preloadedMsg = null }) => {
            const [messages, setMessages] = useState([]);
            const [inputText, setInputText] = useState("");
            const bottomRef = useRef(null);

            // Cargar mensajes
            useEffect(() => {
                if (!isOpen) return;
                
                // Si hay un mensaje precargado (reporte autom√°tico), enviarlo
                if (preloadedMsg) {
                    sendMessage(preloadedMsg.text, preloadedMsg.attachment);
                }

                const unsub = db.collection('chat_logs')
                    .orderBy('createdAt', 'asc')
                    .onSnapshot(snapshot => {
                        const msgs = snapshot.docs
                            .map(d => ({id: d.id, ...d.data()}))
                            .filter(m => 
                                // Filtrar mensajes borrados por Viry
                                !m.deletedByViry && 
                                // Mostrar solo conversaci√≥n entre ellos dos
                                ((m.sender === user && m.recipient === target) || (m.sender === target && m.recipient === user))
                            );
                        setMessages(msgs);
                        // Sonido si el √∫ltimo mensaje es de Balta
                        if(msgs.length > 0) {
                            const last = msgs[msgs.length - 1];
                            if(last.sender === target) SOUND_MSG.play();
                        }
                    });
                return () => unsub();
            }, [isOpen]);

            useEffect(() => {
                bottomRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages]);

            const sendMessage = async (text, attachment = null) => {
                if (!text && !attachment) return;
                try {
                    await db.collection('chat_logs').add({
                        text: text,
                        attachment: attachment, // Objeto con datos del reporte
                        sender: user,
                        recipient: target,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        deletedByViry: false,
                        deletedByBalta: false
                    });
                    setInputText("");
                } catch (e) { console.error("Error enviando", e); }
            };

            const deleteMessage = async (msgId) => {
                // Borrado l√≥gico: solo se oculta para Viry, persiste para Admin
                await db.collection('chat_logs').doc(msgId).update({
                    deletedByViry: true
                });
            };

            if (!isOpen) return null;

            const isDark = theme === "dark";
            const bgClass = isDark ? "bg-[#1a0b1c] text-white" : "bg-pink-50 text-slate-800";
            const bubbleMy = isDark ? "bg-fuchsia-600 text-white" : "bg-pink-500 text-white";
            const bubbleOther = isDark ? "bg-gray-800 text-gray-200" : "bg-white text-slate-600 shadow-sm border border-slate-100";

            return (
                <div className={`fixed inset-0 z-[900] flex flex-col chat-panel ${bgClass}`}>
                    {/* Header */}
                    <div className={`p-4 flex justify-between items-center shadow-md z-10 ${isDark ? 'bg-black/40 border-b border-white/10' : 'bg-white/80 border-b border-pink-100'}`}>
                        <div className="flex items-center gap-3">
                            <div className="relative">
                                <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold ${isDark ? 'bg-blue-600' : 'bg-blue-100 text-blue-600'}`}>
                                    {target[0]}
                                </div>
                                <div className="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
                            </div>
                            <div>
                                <h3 className="font-bold text-sm">Chat con {target}</h3>
                                <span className="text-[10px] opacity-60 uppercase tracking-wider">Canal Oficial de Incidencias</span>
                            </div>
                        </div>
                        <CloseButton onClick={onClose} dark={isDark} />
                    </div>

                    {/* Messages Area */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        {messages.length === 0 && (
                            <div className="text-center opacity-40 text-xs mt-10">
                                <Icon name="message-circle" size={40} className="mb-2 mx-auto"/>
                                <p>Inicio del historial laboral con {target}.</p>
                                <p>Los mensajes eliminados se archivan para administraci√≥n.</p>
                            </div>
                        )}
                        
                        {messages.map((msg) => {
                            const isMe = msg.sender === user;
                            return (
                                <div key={msg.id} className={`flex ${isMe ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`max-w-[80%] rounded-2xl p-3 relative group ${isMe ? bubbleMy : bubbleOther} ${isMe ? 'rounded-tr-none' : 'rounded-tl-none'}`}>
                                        
                                        {/* Bot√≥n borrar (solo visible al hover/tap) */}
                                        <button onClick={() => deleteMessage(msg.id)} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity shadow-sm">
                                            <Icon name="trash-2" size={12} />
                                        </button>

                                        {/* Attachment Card (Papeleta) */}
                                        {msg.attachment && (
                                            <div className={`mb-2 p-3 rounded-lg border ${isDark ? 'bg-black/30 border-white/10' : 'bg-white/90 border-pink-200'}`}>
                                                <div className="flex items-center gap-2 mb-1 border-b border-dashed border-gray-400/30 pb-1">
                                                    <Icon name="alert-triangle" size={14} className="text-amber-500" />
                                                    <span className="text-[10px] font-bold uppercase text-amber-500">Incidencia Reportada</span>
                                                </div>
                                                <div className="text-xs space-y-1">
                                                    <div className="font-mono font-bold">{msg.attachment.code}</div>
                                                    <div className="opacity-80">{msg.attachment.modelo}</div>
                                                    <div className="text-[10px] opacity-60">{new Date(msg.createdAt?.seconds * 1000).toLocaleTimeString()}</div>
                                                </div>
                                            </div>
                                        )}
                                        
                                        <p className="text-sm whitespace-pre-wrap">{msg.text}</p>
                                    </div>
                                </div>
                            );
                        })}
                        <div ref={bottomRef}></div>
                    </div>

                    {/* Input Area */}
                    <div className={`p-3 ${isDark ? 'bg-black/40' : 'bg-white'} flex gap-2 items-end`}>
                        <textarea 
                            value={inputText}
                            onChange={(e) => setInputText(e.target.value)}
                            placeholder={`Escribe a ${target}...`}
                            className={`flex-1 rounded-2xl p-3 text-sm focus:outline-none resize-none h-12 py-3 ${isDark ? 'bg-gray-800 text-white placeholder-gray-500' : 'bg-gray-100 text-slate-800'}`}
                        />
                        <button onClick={() => sendMessage(inputText)} className={`w-12 h-12 rounded-full flex items-center justify-center shadow-lg transition-transform active:scale-95 ${isDark ? 'bg-fuchsia-600 text-white' : 'bg-pink-500 text-white'}`}>
                            <Icon name="send" size={20} />
                        </button>
                    </div>
                </div>
            );
        };

        // ==========================================
        // MODO 1: INDIVIDUAL (CON REPORTE)
        // ==========================================
        const IndividualMode = ({ onExit, openChat }) => {
            const [orders, setOrders] = useState([]);
            const [showScan, setShowScan] = useState(false);
            const [scans, setScans] = useState([]);
            const [msg, setMsg] = useState("Escanea una prenda");
            
            // Estado para Conflicto (cuando escaneamos algo de Balta)
            const [conflict, setConflict] = useState(null); 

            const qrRef = useRef(null);

            useEffect(() => {
                const unsub = db.collection('orders').where('status','!=','ARCHIVADO').onSnapshot(s => {
                    setOrders(s.docs.map(d => ({...d.data(), id: d.id})));
                });
                return () => unsub();
            }, []);

            const handleScan = async (text, html5QrCode) => {
                const code = text.trim().toUpperCase();
                html5QrCode.pause();

                try {
                    // 1. Chequeo Global
                    const dupCheck = await db.collection('registro_produccion').where('codigo_paquete', '==', code).limit(1).get();
                    
                    if (!dupCheck.empty) {
                        const culp = dupCheck.docs[0].data();
                        
                        // Si el tejedor es Balta (u otro), permitimos reportar
                        if (culp.tejedor && culp.tejedor !== "Viry") {
                            SOUND_ERROR.play();
                            setMsg(`‚õî YA ESCANEADO POR: ${culp.tejedor}`);
                            
                            // GUARDAR CONFLICTO PARA MOSTRAR BOT√ìN DE REPORTE
                            setConflict({
                                code: code,
                                modelo: culp.modelo,
                                tejedor: culp.tejedor,
                                timestamp: new Date()
                            });

                        } else {
                            SOUND_ERROR.play();
                            setMsg("‚õî YA LO ESCANESTE T√ö");
                            setTimeout(() => { setMsg("Escanea una prenda"); html5QrCode.resume(); }, 2000);
                        }
                        return;
                    }

                    // 2. Proceso normal si no hay duplicado
                    let found = null;
                    orders.forEach(o => {
                        const p = o.progreso?.find(pkg => pkg.codigoUnico === code);
                        if (p) found = { code, modelo: o.codigo, orderId: o.id, partida: o.partida || "S/N", paquete_indice: p.paqueteNum || 0 };
                    });

                    if (found) {
                        SOUND_SUCCESS.play();
                        setScans(prev => [found, ...prev]);
                        setMsg(`üå∏ ${found.modelo} Agregado`);
                        setTimeout(() => { setMsg("Escanea una prenda"); html5QrCode.resume(); }, 1500);
                    } else {
                        SOUND_ERROR.play();
                        setMsg("‚ùå No encontrado en pedidos");
                        setTimeout(() => { setMsg("Escanea una prenda"); html5QrCode.resume(); }, 2000);
                    }

                } catch (e) {
                    console.error(e);
                    setMsg("Error conexi√≥n");
                    html5QrCode.resume();
                }
            };

            useEffect(() => {
                if (showScan && !qrRef.current) {
                    const qr = new Html5Qrcode("reader-std");
                    qrRef.current = qr;
                    qr.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, 
                        (t) => handleScan(t, qr), () => {}
                    );
                }
                return () => { if(qrRef.current && qrRef.current.isScanning) qrRef.current.stop(); qrRef.current = null; };
            }, [showScan, orders]);

            const confirmBatch = async () => {
                const b = db.batch();
                scans.forEach(s => {
                    b.set(db.collection('registro_produccion').doc(), { ...s, fecha: new Date(), tejedor: "Viry", device: "ViryScan", tipo_scan: "INDIVIDUAL" });
                });
                await b.commit();
                setScans([]); setShowScan(false);
            };

            // Funci√≥n para reportar conflicto
            const reportConflict = () => {
                if (!conflict) return;
                const reportMsg = {
                    text: `‚ö†Ô∏è Hola Balta, me apareci√≥ este c√≥digo que ya escaneaste t√∫. Revisa por favor.`,
                    attachment: conflict
                };
                openChat(reportMsg); // Abrir chat con mensaje precargado
                setConflict(null); // Limpiar conflicto
                setMsg("Reporte enviado. Continuando...");
                if(qrRef.current) qrRef.current.resume();
            };

            const cancelConflict = () => {
                setConflict(null);
                setMsg("Escanea una prenda");
                if(qrRef.current) qrRef.current.resume();
            }

            return (
                <div className="min-h-screen flex flex-col items-center bg-pink-50 relative">
                    {/* Header Individual */}
                    <div className="w-full bg-white/80 backdrop-blur p-4 flex justify-between items-center shadow-sm border-b border-pink-100 z-10 sticky top-0">
                        <div className="flex items-center gap-2">
                             <div className="w-8 h-8 bg-pink-500 rounded-full flex items-center justify-center text-white font-bold">V</div>
                             <span className="font-bold-modern text-pink-600">Viry<span className="text-slate-400">Scan</span></span>
                        </div>
                        <button onClick={onExit} className="text-xs font-bold text-slate-400 border border-slate-200 px-3 py-1 rounded-full">MEN√ö</button>
                    </div>

                    <div className="flex-1 flex flex-col items-center justify-center w-full max-w-md px-6">
                        <div onClick={() => setShowScan(true)} className="w-full aspect-square max-w-[250px] bg-white rounded-[3rem] shadow-[0_10px_40px_-10px_rgba(236,72,153,0.3)] border border-pink-100 flex flex-col items-center justify-center gap-4 cursor-pointer hover:scale-105 transition-all group">
                            <Icon name="barcode" size={40} className="text-pink-500 group-hover:text-pink-600" />
                            <span className="font-bold text-pink-400">INICIAR ESCANER</span>
                        </div>
                    </div>

                    {showScan && (
                        <div className="fixed inset-0 z-[700] bg-white flex flex-col">
                            <div className="p-4 flex justify-between items-center bg-pink-50">
                                <h2 className="font-bold text-pink-600">Escaneando</h2>
                                <CloseButton onClick={() => setShowScan(false)} />
                            </div>
                            <div className="p-4 bg-pink-50 pb-8 rounded-b-[2rem] shadow-sm">
                                <div className="scan-wrapper border-4 border-white shadow-lg"><div id="reader-std"></div></div>
                                
                                {/* UI DE CONFLICTO */}
                                {conflict ? (
                                    <div className="mt-4 bg-red-50 border border-red-100 p-4 rounded-xl animate-bounce-small">
                                        <p className="text-red-500 font-bold text-center text-sm mb-2">{msg}</p>
                                        <div className="flex gap-2">
                                            <button onClick={cancelConflict} className="flex-1 py-2 bg-gray-200 text-gray-600 rounded-lg text-xs font-bold">IGNORAR</button>
                                            <button onClick={reportConflict} className="flex-1 py-2 bg-red-500 text-white rounded-lg text-xs font-bold flex items-center justify-center gap-2 shadow-lg shadow-red-200">
                                                <Icon name="message-square-warning" size={16}/> AVISAR A BALTA
                                            </button>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="text-center mt-4 font-bold text-pink-500">{msg}</div>
                                )}
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                {scans.map((s, idx) => (
                                    <div key={idx} className="bg-white p-3 rounded-xl border border-pink-100 shadow-sm flex justify-between">
                                        <span className="font-bold text-slate-700">{s.modelo}</span>
                                        <span className="text-xs bg-pink-100 text-pink-600 px-2 py-1 rounded">#{s.paquete_indice}</span>
                                    </div>
                                ))}
                            </div>
                            <div className="p-4"><button onClick={confirmBatch} className="w-full py-4 bg-pink-500 text-white rounded-xl font-bold">GUARDAR ({scans.length})</button></div>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // MODO 2: KITS (CON REPORTE)
        // ==========================================
        const KitMode = ({ onExit, openChat }) => {
            const [scanning, setScanning] = useState(false);
            const [scannedData, setScannedData] = useState(null);
            const [status, setStatus] = useState("Esperando Kit...");
            const [conflict, setConflict] = useState(null);

            useEffect(() => {
                if (scanning) {
                    const qr = new Html5Qrcode("reader-kit");
                    qr.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, 
                        async (code) => {
                            qr.stop(); setScanning(false);
                            
                            // Verificar Duplicado
                            const dup = await db.collection('registro_produccion').where('kitId', '==', code).limit(1).get();
                            if (!dup.empty) {
                                const info = dup.docs[0].data();
                                SOUND_ERROR.play();
                                setStatus(`‚õî YA REGISTRADO POR: ${info.tejedor}`);
                                
                                if(info.tejedor !== "Viry") {
                                    setConflict({
                                        code: code,
                                        modelo: info.modelo || "Kit Desconocido",
                                        tejedor: info.tejedor,
                                        timestamp: new Date()
                                    });
                                }
                                return;
                            }

                            // Buscar Kit
                            const k = await db.collection('kits_datos').doc(code).get();
                            if (k.exists) {
                                SOUND_SUCCESS.play();
                                const d = k.data();
                                setScannedData({ id: code, ...d, cantidad: d.piezas.length });
                                setStatus("‚ú® ¬°Kit Encontrado!");
                            } else {
                                SOUND_ERROR.play();
                                setStatus("‚ùå No es un Kit v√°lido");
                            }
                        }, 
                        () => {}
                    );
                    return () => { try { qr.stop(); } catch(e){} };
                }
            }, [scanning]);

            const reportConflict = () => {
                if (!conflict) return;
                openChat({
                    text: `‚ö†Ô∏è Hola Balta, intent√© registrar este KIT pero aparece a tu nombre.`,
                    attachment: conflict
                });
                setConflict(null);
                setStatus("Reporte enviado");
            };

            const confirmRegister = async () => {
                if (!scannedData) return;
                const b = db.batch();
                scannedData.piezas.forEach(p => {
                    b.set(db.collection('registro_produccion').doc(), {
                        codigo_paquete: p.codigoUnico, modelo: scannedData.modelo, partida: scannedData.partida,
                        tejedor: "Viry", fecha: new Date(), kitId: scannedData.id, tipo_scan: "KIT"
                    });
                });
                await b.commit();
                SOUND_SUCCESS.play();
                setScannedData(null); setStatus("üíñ Kit Registrado");
            };

            return (
                <div className="flex flex-col h-screen w-full relative bg-[#1a0b1c] text-white">
                    <button onClick={onExit} className="absolute top-4 left-4 z-50 bg-white/10 px-4 py-2 rounded-full text-xs font-bold border border-white/20">SALIR</button>
                    
                    <div className="p-8 text-center mt-6">
                        <h1 className="text-5xl font-hand text-transparent bg-clip-text bg-gradient-to-r from-fuchsia-400 to-purple-400">Viry Kits</h1>
                    </div>

                    <div className="flex-1 px-4 flex flex-col justify-center items-center relative z-10">
                        <p className="mb-4 font-bold text-purple-300">{status}</p>

                        {/* UI CONFLICTO KIT */}
                        {conflict && (
                            <div className="mb-6 w-full max-w-sm bg-red-900/50 border border-red-500 p-4 rounded-xl text-center backdrop-blur-md">
                                <p className="text-red-300 text-xs mb-3">El sistema detect√≥ que Balta ya escane√≥ este paquete.</p>
                                <button onClick={reportConflict} className="w-full py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg flex items-center justify-center gap-2 shadow-[0_0_15px_rgba(220,38,38,0.5)]">
                                    <Icon name="bell-ring" size={18} /> NOTIFICAR A BALTA
                                </button>
                                <button onClick={() => setConflict(null)} className="mt-2 text-xs text-red-300 underline">Ignorar y cerrar</button>
                            </div>
                        )}

                        {!scanning && !scannedData && !conflict && (
                            <button onClick={() => setScanning(true)} className="w-56 h-56 rounded-full bg-purple-900/30 border-2 border-fuchsia-500/50 flex flex-col items-center justify-center pulse-btn">
                                <Icon name="package-check" size={56} className="text-fuchsia-300 mb-3" />
                                <span className="text-xl font-bold text-white">Escanear Kit</span>
                            </button>
                        )}

                        {scanning && <div id="reader-kit" className="w-full max-w-sm h-72 rounded-2xl overflow-hidden border-2 border-fuchsia-500"></div>}

                        {scannedData && (
                            <div className="w-full max-w-sm bg-white/10 backdrop-blur border border-white/10 p-6 rounded-3xl">
                                <h2 className="text-3xl font-bold mb-2">{scannedData.modelo}</h2>
                                <p className="text-purple-300 text-sm mb-6">{scannedData.cantidad} Prendas</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setScannedData(null)} className="flex-1 py-3 bg-white/10 rounded-xl font-bold">Cancelar</button>
                                    <button onClick={confirmRegister} className="flex-[2] py-3 bg-gradient-to-r from-fuchsia-600 to-purple-600 rounded-xl font-bold shadow-lg">REGISTRAR</button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // ==========================================
        // APP PRINCIPAL
        // ==========================================
        const App = () => {
            const [view, setView] = useState('menu');
            const [chatOpen, setChatOpen] = useState(false);
            const [chatPreload, setChatPreload] = useState(null);

            // Manejar apertura de chat (posiblemente con mensaje autom√°tico)
            const openChat = (preloadMsg = null) => {
                if (preloadMsg) setChatPreload(preloadMsg);
                else setChatPreload(null);
                setChatOpen(true);
            };

            const chatTheme = view === 'kit' ? 'dark' : 'light';

            return (
                <div className="split-container font-sans relative">
                    
                    {/* VISTA: MENU */}
                    {view === 'menu' && (
                        <>
                            <div className="split-section bg-pink-50" onClick={() => setView('individual')}>
                                <div className="text-center">
                                    <div className="w-20 h-20 mx-auto bg-pink-100 rounded-full flex items-center justify-center mb-4"><Icon name="shirt" size={32} className="text-pink-500"/></div>
                                    <h2 className="text-3xl font-hand text-pink-600">Individual</h2>
                                </div>
                            </div>
                            <div className="split-section bg-[#1a0b1c] border-t-4 border-fuchsia-900" onClick={() => setView('kit')}>
                                <div className="text-center">
                                    <div className="w-20 h-20 mx-auto bg-fuchsia-900/50 rounded-full flex items-center justify-center mb-4 border border-fuchsia-500"><Icon name="layers" size={32} className="text-fuchsia-300"/></div>
                                    <h2 className="text-3xl font-hand text-fuchsia-300">Kits</h2>
                                </div>
                            </div>
                        </>
                    )}

                    {/* VISTAS: MODOS DE TRABAJO */}
                    {view === 'individual' && <IndividualMode onExit={() => setView('menu')} openChat={openChat} />}
                    {view === 'kit' && <KitMode onExit={() => setView('menu')} openChat={openChat} />}

                    {/* --- BOT√ìN FLOTANTE DEL CHAT (GLOBAL) --- */}
                    {!chatOpen && view !== 'menu' && (
                        <button 
                            onClick={() => openChat()} 
                            className={`fixed bottom-6 right-6 z-[800] w-14 h-14 rounded-full shadow-2xl flex items-center justify-center transition-transform hover:scale-110 active:scale-95 ${view === 'kit' ? 'bg-fuchsia-600 text-white shadow-fuchsia-900/50' : 'bg-pink-500 text-white shadow-pink-300'}`}
                        >
                            <Icon name="message-circle" size={28} />
                            {/* Indicador de "Online" simulado */}
                            <span className="absolute top-0 right-0 w-4 h-4 bg-green-500 border-2 border-white rounded-full"></span>
                        </button>
                    )}

                    {/* --- COMPONENTE CHAT --- */}
                    <WorkChat 
                        isOpen={chatOpen} 
                        onClose={() => setChatOpen(false)} 
                        theme={chatTheme}
                        preloadedMsg={chatPreload}
                        user="Viry"
                        target="Balta"
                    />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
