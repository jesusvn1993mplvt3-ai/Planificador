<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cirineo Ultimate v3 - Integrated</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        /* ESTILOS GLOBALES */
        body { overflow: hidden; overscroll-behavior: none; user-select: none; -webkit-user-select: none; }
        
        /* ANIMACIONES */
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(255, 0, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); } }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(0, 255, 0, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(0, 255, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 255, 0, 0); } }

        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .scan-success { animation: pulse-green 0.5s; }
        .scan-error { animation: pulse-red 0.5s; }

        /* --- TEMAS VISUALES --- */

        /* JVN93: TERMINAL */
        .theme-terminal { background-color: #0c0c0c; color: #00ff00; font-family: 'Courier New', monospace; }
        .theme-terminal .btn { border: 1px solid #00ff00; background: #001100; text-transform: uppercase; border-radius: 0; }
        .theme-terminal .card { border: 1px solid #00ff00; background: #000; }
        
        /* BALTA: KOF (Videojuego Pelea) */
        .theme-kof { background: linear-gradient(135deg, #2b0808 0%, #5e0b0b 100%); color: white; font-family: 'Impact', sans-serif; letter-spacing: 0.5px; }
        .theme-kof .btn { background: linear-gradient(to bottom, #ef4444, #991b1b); border: 2px solid #fcd34d; transform: skewX(-10deg); box-shadow: 3px 3px 0 #000; text-shadow: 1px 1px 0 #000; }
        .theme-kof .btn:active { transform: skewX(-10deg) translateY(2px); box-shadow: 1px 1px 0 #000; }
        .theme-kof .card { background: rgba(0,0,0,0.8); border: 1px solid #ef4444; transform: skewX(-2deg); }

        /* JOEL: MARIO BROS */
        .theme-mario { background-color: #5c94fc; font-family: 'Arial Rounded MT Bold', 'Verdana', sans-serif; background-image: radial-gradient(white 15%, transparent 16%), radial-gradient(white 15%, transparent 16%); background-size: 30px 30px; background-position: 0 0, 15px 15px; }
        .theme-mario .btn { background: #e52521; border: 3px solid white; border-radius: 12px; box-shadow: 0 4px 0 #9f110e; color: white; text-transform: uppercase; }
        .theme-mario .btn:active { transform: translateY(4px); box-shadow: none; }
        .theme-mario .card { background: #fff; border: 4px solid #fbd000; border-radius: 10px; color: #333; box-shadow: 0 4px 0 rgba(0,0,0,0.2); }

        /* SUSAN: POKEMON (PIKACHU) */
        .theme-pokemon { background-color: #facc15; color: #374151; font-family: 'Verdana', sans-serif; }
        .theme-pokemon .btn { background: white; border: 3px solid #374151; border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .theme-pokemon .btn::after { content: ''; position: absolute; width: 100%; height: 50%; background: #ef4444; top: 0; left: 0; border-bottom: 3px solid #374151; }
        .theme-pokemon .btn-center { width: 15px; height: 15px; background: white; border: 3px solid #374151; border-radius: 50%; position: absolute; z-index: 10; }
        .theme-pokemon .card { background: #fdfdfd; border: 2px solid #3b82f6; border-radius: 8px; box-shadow: 3px 3px 0 rgba(0,0,0,0.1); }

        /* MARCO: iOS PRO */
        .theme-ios { background-color: #f2f2f7; color: #1c1c1e; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
        .theme-ios .btn { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-radius: 12px; color: #007aff; font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: none; }
        .theme-ios .btn-primary { background: #007aff; color: white; }
        .theme-ios .card { background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: none; }

        /* Cámara */
        #reader { width: 100%; height: 100%; object-fit: cover; background: black; }
        video { object-fit: cover !important; width: 100% !important; height: 100% !important; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const { jsPDF } = window.jspdf;

        // --- FIREBASE CONFIG (Tu configuración existente) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- USUARIOS HARDCODED (Para recuperación automática) ---
        const INITIAL_USERS = [
            { pin: "13524680", name: "JVN93", role: "admin", theme: "terminal", permissions: ["all"] },
            { pin: "4895", name: "BALTA", role: "scanner", theme: "kof", permissions: ["scan"] },
            { pin: "6574", name: "JOEL", role: "viewer", theme: "mario", permissions: ["scan", "view"] },
            { pin: "5555", name: "SUSAN", role: "manager", theme: "pokemon", permissions: ["scan", "view", "approve"] },
            { pin: "0000", name: "MARCO ESPINOZA", role: "pro", theme: "ios", permissions: ["scan", "view", "approve", "shortcuts"], shortcuts: [{name: "Reporte", url: "https://google.com"}, {name: "Inventario", url: "https://google.com"}] }
        ];

        // --- ICONOS ---
        const Icon = ({ name, size = 20, className }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && lucide.icons[name]) ref.current.innerHTML = lucide.icons[name].toSvg({ width: size, height: size, class: className });
            }, [name, className]);
            return <span ref={ref}></span>;
        };

        // --- SONIDOS TEMÁTICOS (Web Audio API) ---
        const playSound = (type, theme) => {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            const now = ctx.currentTime;

            // SONIDOS PERSONALIZADOS
            if (theme === 'pokemon') {
                // Pikachu Style
                if (type === 'success') {
                    osc.type = 'triangle'; osc.frequency.setValueAtTime(800, now); osc.frequency.linearRampToValueAtTime(1400, now+0.1);
                    gain.gain.setValueAtTime(0.5, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.2);
                    osc.start(now); osc.stop(now+0.2);
                } else { // Error
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now+0.3);
                    osc.start(now); osc.stop(now+0.3);
                }
            } else if (theme === 'mario') {
                // Coin Style
                if (type === 'success') {
                    osc.type = 'square'; osc.frequency.setValueAtTime(988, now); gain.gain.value = 0.1;
                    osc.start(now); osc.stop(now+0.1);
                    setTimeout(()=>{
                        const o2=ctx.createOscillator(); const g2=ctx.createGain(); o2.connect(g2); g2.connect(ctx.destination);
                        o2.type='square'; o2.frequency.setValueAtTime(1319, ctx.currentTime); g2.gain.value=0.1;
                        o2.start(); o2.stop(ctx.currentTime+0.1);
                    }, 80);
                } else { // Pipe Hit
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(50, now+0.15);
                    osc.start(now); osc.stop(now+0.15);
                }
            } else if (theme === 'kof') {
                // Punch Style
                if (type === 'success') {
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, now); osc.frequency.exponentialRampToValueAtTime(50, now+0.1);
                    gain.gain.setValueAtTime(1, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.1);
                    osc.start(now); osc.stop(now+0.1);
                } else {
                     osc.type = 'square'; osc.frequency.setValueAtTime(50, now); osc.start(now); osc.stop(now+0.3);
                }
            } else {
                // Standard / iOS / Terminal
                if (type === 'success') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(1000, now); osc.start(now); osc.stop(now+0.1);
                } else {
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, now); osc.start(now); osc.stop(now+0.2);
                }
            }
        };

        // --- COMPONENTE: LOGIN ---
        const LoginScreen = ({ onLogin }) => {
            const [pin, setPin] = useState("");
            const [loading, setLoading] = useState(false);

            const handleLogin = async () => {
                setLoading(true);
                // 1. Check Local (Recuperación)
                const hardcoded = INITIAL_USERS.find(u => u.pin === pin);
                if (hardcoded) {
                    try { await db.collection('users').doc(hardcoded.pin).set(hardcoded); } catch(e){} // Sync silent
                    onLogin(hardcoded);
                    return;
                }
                // 2. Check DB
                try {
                    const snap = await db.collection('users').where('pin', '==', pin).get();
                    if (!snap.empty) onLogin(snap.docs[0].data());
                    else { alert("PIN INCORRECTO"); setPin(""); }
                } catch(e) { alert("Error Conexión"); }
                setLoading(false);
            };

            return (
                <div className="h-screen bg-slate-900 flex flex-col items-center justify-center p-6 text-white">
                    <div className="mb-6 text-center animate-fade-in">
                        <h1 className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-green-400">CIRINEO v3</h1>
                        <p className="text-slate-400 text-xs tracking-widest mt-1">ULTIMATE SCANNER</p>
                    </div>
                    <div className="bg-slate-800 p-4 rounded-xl text-3xl font-mono tracking-[0.5em] mb-6 border border-slate-700 w-64 text-center h-16 flex items-center justify-center">
                        {pin ? pin.replace(/./g, '•') : <span className="text-slate-600 text-sm tracking-normal">INGRESE PIN</span>}
                    </div>
                    <div className="grid grid-cols-3 gap-3 w-64">
                        {[1,2,3,4,5,6,7,8,9].map(n => <button key={n} onClick={()=>setPin(p=>p.length<8?p+n:p)} className="bg-slate-700 h-16 rounded-lg text-xl font-bold active:bg-blue-600 transition-colors">{n}</button>)}
                        <button onClick={()=>setPin("")} className="bg-red-900/50 text-red-400 rounded-lg flex items-center justify-center"><Icon name="x"/></button>
                        <button onClick={()=>setPin(p=>p+"0")} className="bg-slate-700 h-16 rounded-lg text-xl font-bold">0</button>
                        <button onClick={handleLogin} className="bg-green-600 text-white rounded-lg flex items-center justify-center"><Icon name="arrow-right"/></button>
                    </div>
                    {loading && <p className="mt-4 text-xs animate-pulse text-blue-400">Accediendo...</p>}
                </div>
            );
        };

        // --- COMPONENTE: APP PRINCIPAL ---
        const MainApp = ({ user, onLogout }) => {
            const [scanning, setScanning] = useState(false);
            const [orders, setOrders] = useState([]); // Cache de órdenes para validar
            const [lastScan, setLastScan] = useState(null); // Último escaneo para feedback
            const [showChat, setShowChat] = useState(false);
            const [showConsolidator, setShowConsolidator] = useState(false);
            const scannerRef = useRef(null);

            // 1. CARGAR ÓRDENES EN SEGUNDO PLANO (Integración con CIRINEO.html)
            useEffect(() => {
                const unsub = db.collection('orders').where('status', '!=', 'ARCHIVADO').onSnapshot(snap => {
                    const loaded = snap.docs.map(d => ({...d.data(), id: d.id}));
                    setOrders(loaded);
                });
                return () => unsub();
            }, []);

            // 2. LÓGICA DE CÁMARA
            useEffect(() => {
                if (scanning) startCamera();
                else stopCamera();
            }, [scanning]);

            const startCamera = async () => {
                try {
                    const devices = await Html5Qrcode.getCameras();
                    if (devices && devices.length) {
                        // Forzar cámara trasera (Intento inteligente)
                        let cameraId = devices[0].id;
                        // Si hay más de 1, buscamos palabras clave o usamos la segunda (índice 1)
                        if (devices.length > 1) {
                            const back = devices.find(d => d.label.toLowerCase().includes('back') || d.label.toLowerCase().includes('trasera') || d.label.toLowerCase().includes('environment'));
                            cameraId = back ? back.id : devices[1].id;
                        }

                        const html5QrCode = new Html5Qrcode("reader");
                        scannerRef.current = html5QrCode;
                        await html5QrCode.start(
                            cameraId, 
                            { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 },
                            (decodedText) => handleScan(decodedText),
                            () => {}
                        );
                    } else { alert("No se encontró cámara"); setScanning(false); }
                } catch(e) { console.error(e); alert("Error Cámara: " + e.message); setScanning(false); }
            };

            const stopCamera = () => {
                if (scannerRef.current) {
                    scannerRef.current.stop().catch(e=>console.error(e)).finally(() => {
                        scannerRef.current.clear();
                        scannerRef.current = null;
                    });
                }
            };

            // 3. PROCESAMIENTO DEL ESCANEO (INTEGRACIÓN REAL)
            const handleScan = async (code) => {
                // Evitar lecturas dobles muy rápidas
                if (scannerRef.current) scannerRef.current.pause();

                const cleanCode = code.trim().toUpperCase();
                
                // 3.1. Validar contra órdenes cargadas
                let foundPkg = null;
                let foundOrder = null;

                for (const o of orders) {
                    if (o.progreso) {
                        const p = o.progreso.find(pkg => pkg.codigoUnico === cleanCode);
                        if (p) { foundPkg = p; foundOrder = o; break; }
                    }
                }

                if (foundPkg && foundOrder) {
                    playSound('success', user.theme);
                    // 3.2. Subir a Firebase (Formato Consolidador)
                    // Checar duplicado rápido (opcional, Firestore lo maneja pero mejor evitar escritura)
                    try {
                         // Crear registro compatible con Consolidador.html
                         await db.collection('registro_produccion').add({
                            codigo_paquete: cleanCode,
                            orderId: String(foundOrder.id),
                            modelo: foundOrder.codigo,
                            partida: foundOrder.partida,
                            paquete_indice: foundPkg.paqueteNum,
                            paquete_total: foundPkg.paquetesDePieza,
                            piezas_en_paquete: foundPkg.cantidad,
                            tejedor: user.name,
                            fecha: firebase.firestore.FieldValue.serverTimestamp(),
                            fecha_scan: new Date().toLocaleString('es-MX'),
                            tipo: "produccion"
                         });
                         setLastScan({ status: 'ok', msg: `${foundOrder.codigo} - PQT ${foundPkg.paqueteNum}` });
                    } catch(e) {
                         console.error(e);
                         setLastScan({ status: 'err', msg: "Error al guardar" });
                    }
                } else {
                    playSound('error', user.theme);
                    setLastScan({ status: 'err', msg: "CÓDIGO NO ENCONTRADO" });
                }

                // Reanudar cámara
                setTimeout(() => {
                    if (scanning && scannerRef.current) scannerRef.current.resume();
                }, 1500);
            };

            // CLASE BASE DEL TEMA
            const themeClass = `h-screen flex flex-col theme-${user.theme}`;

            return (
                <div className={themeClass}>
                    {/* TOP BAR */}
                    <div className="p-4 flex justify-between items-center bg-black/10 backdrop-blur-sm z-20">
                        <div className="flex items-center gap-2">
                            <div className="w-10 h-10 rounded-full border-2 border-current flex items-center justify-center text-xl font-black uppercase">
                                {user.name.charAt(0)}
                            </div>
                            <div className="leading-none">
                                <div className="font-bold text-sm">{user.name}</div>
                                <div className="text-[10px] opacity-70">{user.role}</div>
                            </div>
                        </div>
                        <button onClick={onLogout} className="p-2 opacity-70"><Icon name="log-out"/></button>
                    </div>

                    {/* CONTENT AREA */}
                    <div className="flex-1 relative bg-black/5 flex flex-col overflow-hidden">
                        {scanning ? (
                            <div className="absolute inset-0 bg-black flex flex-col z-30">
                                <div className="relative flex-1">
                                    <div id="reader"></div>
                                    {/* Overlay Visual */}
                                    <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                        <div className="w-64 h-64 border-2 border-white/50 relative">
                                            <div className="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-green-500"></div>
                                            <div className="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-green-500"></div>
                                            <div className="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-green-500"></div>
                                            <div className="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-green-500"></div>
                                        </div>
                                    </div>
                                    {lastScan && (
                                        <div className={`absolute bottom-10 left-0 right-0 mx-auto w-3/4 text-center py-2 rounded font-bold text-white shadow-lg ${lastScan.status === 'ok' ? 'bg-green-600 scan-success' : 'bg-red-600 scan-error'}`}>
                                            {lastScan.msg}
                                        </div>
                                    )}
                                </div>
                                <div className="p-4 bg-gray-900 flex justify-center">
                                    <button onClick={()=>{setScanning(false); setLastScan(null);}} className="bg-red-600 text-white font-bold py-3 px-8 rounded-full shadow-lg">DETENER CÁMARA</button>
                                </div>
                            </div>
                        ) : (
                            <div className="h-full flex flex-col items-center justify-center p-6 gap-6 animate-slide-up">
                                <button onClick={()=>setScanning(true)} className="btn w-48 h-48 rounded-2xl flex flex-col items-center justify-center gap-2 shadow-xl active:scale-95 transition-transform">
                                    <Icon name="scan" size={48}/>
                                    <span className="text-xl font-black">ESCANEAR</span>
                                </button>
                                
                                {user.role === 'pro' && user.shortcuts && (
                                    <div className="grid grid-cols-2 gap-3 w-full max-w-sm">
                                        {user.shortcuts.map((sc,i)=>(
                                            <a key={i} href={sc.url} target="_blank" className="card p-3 text-center font-bold text-sm block no-underline text-current">{sc.name}</a>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                    {/* BOTTOM NAV */}
                    <div className="p-2 pb-6 flex justify-around items-center bg-white/5 backdrop-blur-md border-t border-white/10 z-20">
                        <button onClick={()=>setShowChat(true)} className="flex flex-col items-center opacity-70 hover:opacity-100 p-2">
                            <Icon name="message-circle" size={24}/>
                            <span className="text-[10px] font-bold mt-1">CHAT</span>
                        </button>
                        
                        {(user.permissions.includes('view') || user.permissions.includes('approve')) && (
                            <button onClick={()=>setShowConsolidator(true)} className="flex flex-col items-center opacity-70 hover:opacity-100 p-2 relative">
                                <Icon name="clipboard-list" size={24}/>
                                {user.permissions.includes('approve') && <span className="absolute top-1 right-2 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>}
                                <span className="text-[10px] font-bold mt-1">PROD.</span>
                            </button>
                        )}
                    </div>

                    {/* MODALES EXTERNOS */}
                    {showChat && <ChatModule user={user} onClose={()=>setShowChat(false)} />}
                    {showConsolidator && <MiniConsolidator user={user} onClose={()=>setShowConsolidator(false)} />}
                </div>
            );
        };

        // --- MÓDULO CHAT (PDF + FIRMA) ---
        const ChatModule = ({ user, onClose }) => {
            const [msgs, setMsgs] = useState([]);
            const [txt, setTxt] = useState("");
            const bottomRef = useRef(null);

            useEffect(()=>{
                const unsub = db.collection('chat_grupal').orderBy('timestamp','desc').limit(50).onSnapshot(s => setMsgs(s.docs.map(d=>d.data()).reverse()));
                return ()=>unsub();
            },[]);
            useEffect(()=>bottomRef.current?.scrollIntoView({behavior:'smooth'}),[msgs]);

            const send = async () => {
                if(!txt.trim()) return;
                await db.collection('chat_grupal').add({ user: user.name, msg: txt, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                setTxt("");
            };

            const downloadPDF = () => {
                const doc = new jsPDF();
                const now = new Date();
                const firma = `ESTA ES UNA COPIA DE LA CONVERSACIÓN GRUPAL DE VIVA ROUSS "TEJIDO" FUE DESCARGADO EL DÍA ${now.toLocaleDateString()} A LA HORA ${now.toLocaleTimeString()} POR ${user.name} QUE USA EL PIN ${user.pin}`;
                
                doc.setFontSize(8); doc.setTextColor(150); doc.text(firma, 10, 10);
                doc.setProperties({ title: "Chat Log", subject: firma, keywords: firma }); // Firma en metadatos
                
                doc.setFontSize(10); doc.setTextColor(0);
                let y = 20;
                msgs.forEach(m => {
                    if(y>280){doc.addPage(); y=20;}
                    doc.setFont(undefined,'bold'); doc.text(`${m.user}:`, 10, y);
                    doc.setFont(undefined,'normal'); doc.text(`${m.msg}`, 40, y);
                    y+=7;
                });
                doc.save(`chat_${now.getTime()}.pdf`);
            };

            return (
                <div className="fixed inset-0 bg-black/90 z-50 flex flex-col p-4 animate-fade-in text-white font-sans">
                    <div className="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                        <h3 className="font-bold">CHAT PLANTA</h3>
                        <div className="flex gap-2">
                            <button onClick={downloadPDF} className="bg-blue-600 px-2 py-1 rounded text-xs font-bold">PDF</button>
                            <button onClick={onClose} className="bg-red-600 px-2 py-1 rounded text-xs font-bold">X</button>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto space-y-2 mb-2">
                        {msgs.map((m,i)=>(
                            <div key={i} className={`p-2 rounded text-sm max-w-[80%] ${m.user===user.name?'bg-blue-900 ml-auto':'bg-gray-800'}`}>
                                <div className="text-[10px] font-bold opacity-50">{m.user}</div>
                                <div>{m.msg}</div>
                            </div>
                        ))}
                        <div ref={bottomRef}></div>
                    </div>
                    <div className="flex gap-2">
                        <input value={txt} onChange={e=>setTxt(e.target.value)} className="flex-1 bg-gray-800 rounded p-2 text-white border border-gray-600 outline-none" placeholder="Escribir..."/>
                        <button onClick={send} className="bg-green-600 px-4 rounded font-bold"><Icon name="send"/></button>
                    </div>
                </div>
            );
        };

        // --- MINI CONSOLIDADOR (SOLO VISTA/APROBACIÓN RÁPIDA) ---
        const MiniConsolidator = ({ user, onClose }) => {
            const [items, setItems] = useState([]);
            useEffect(() => {
                const u = db.collection('registro_produccion').orderBy('fecha','desc').limit(20).onSnapshot(s=>setItems(s.docs.map(d=>({...d.data(), id:d.id}))));
                return ()=>u();
            },[]);

            const canApprove = user.permissions.includes('approve');
            
            const action = async (id, type) => {
                if(!confirm(type==='del'?"¿Borrar?":"¿Aprobar?")) return;
                try {
                    if(type==='del') await db.collection('registro_produccion').doc(id).delete();
                    else {
                        const it = items.find(i=>i.id===id);
                        // Lógica simplificada: Mover a aprobados
                        await db.collection('registros_aprobados').doc(id).set({...it, aprobadoPor: user.name, fechaAprobacion: new Date()});
                        // Nota: La actualización del status 'Verde' en la Orden real lo hace el Consolidador Principal (PC), aquí solo marcamos el registro.
                    }
                } catch(e){ alert(e.message); }
            };

            return (
                <div className="fixed inset-0 bg-slate-100 z-50 flex flex-col animate-slide-up text-slate-800 font-sans">
                    <div className="bg-white p-4 shadow flex justify-between items-center">
                        <h3 className="font-bold">Últimos Escaneos</h3>
                        <button onClick={onClose} className="p-2 bg-slate-200 rounded-full"><Icon name="x"/></button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-2 space-y-2">
                        {items.map(it => (
                            <div key={it.id} className="bg-white p-3 rounded shadow-sm border-l-4 border-indigo-500">
                                <div className="flex justify-between font-bold text-sm">
                                    <span>{it.codigo_paquete}</span>
                                    <span className="text-[10px] text-slate-400">{it.fecha_scan}</span>
                                </div>
                                <div className="text-xs mt-1 text-slate-600">{it.modelo} - {it.partida}</div>
                                <div className="text-[10px] bg-slate-100 inline-block px-1 rounded mt-1">Tejedor: {it.tejedor}</div>
                                {canApprove && (
                                    <div className="flex gap-2 mt-2 pt-2 border-t">
                                        <button onClick={()=>action(it.id, 'ok')} className="flex-1 bg-green-100 text-green-800 text-xs font-bold py-1 rounded">APROBAR</button>
                                        <button onClick={()=>action(it.id, 'del')} className="flex-1 bg-red-100 text-red-800 text-xs font-bold py-1 rounded">BORRAR</button>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const Root = () => {
            const [user, setUser] = useState(null);
            return user ? <MainApp user={user} onLogout={()=>setUser(null)} /> : <LoginScreen onLogin={setUser} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Root />);
    </script>
</body>
</html>
